(function(a){var d=0;"use strict";var b=function(e){this[0]=e.startOffset;this[1]=e.endOffset;this.range=e;return this};b.prototype.equals=function(){return this[0]===this[1]};a.fn.redactor=function(f){var g=[];var e=Array.prototype.slice.call(arguments,1);if(typeof f==="string"){this.each(function(){var h=a.data(this,"redactor");if(typeof h!=="undefined"&&a.isFunction(h[f])){var j=h[f].apply(h,e);if(j!==undefined&&j!==h){g.push(j)}}else{return a.error('No such method "'+f+'" for Redactor')}})}else{this.each(function(){if(!a.data(this,"redactor")){a.data(this,"redactor",c(this,f))}})}if(g.length===0){return this}else{if(g.length===1){return g[0]}else{return g}}};function c(e,f){return new c.prototype.init(e,f)}a.Redactor=c;a.Redactor.VERSION="9.2";a.Redactor.opts={rangy:false,iframe:false,fullpage:false,css:false,lang:"en",direction:"ltr",placeholder:false,typewriter:false,wym:false,mobile:true,cleanup:true,tidyHtml:true,pastePlainText:false,removeEmptyTags:true,templateVars:false,xhtml:false,visual:true,focus:false,tabindex:false,autoresize:true,minHeight:false,maxHeight:false,shortcuts:true,autosave:false,autosaveInterval:60,plugins:false,linkAnchor:true,linkEmail:true,linkProtocol:"http://",linkNofollow:false,linkSize:50,imageFloatMargin:"10px",imageGetJson:false,dragUpload:true,imageTabLink:true,imageUpload:false,imageUploadParam:"file",fileUpload:false,fileUploadParam:"file",clipboardUpload:true,clipboardUploadUrl:false,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:false,uploadFields:false,observeImages:true,observeLinks:true,modalOverlay:true,tabSpaces:false,tabFocus:true,air:false,airButtons:["formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent"],toolbar:true,toolbarFixed:false,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:false,toolbarExternal:false,toolbarOverflow:false,buttonSource:true,buttons:["html","|","formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent","image","video","file","table","link","alignment","horizontalrule"],buttonsHideOnMobile:[],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify","table"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},formattingTags:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],linebreaks:false,paragraphy:true,convertDivs:true,convertLinks:true,convertImageLinks:false,convertVideoLinks:false,formattingPre:false,phpTags:false,allowedTags:false,deniedTags:["html","head","link","body","meta","script","style","applet"],boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:false,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],ownLine:["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine:["li","dt","dt","h[1-6]","option","script"],newLevel:["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"],blockLevelElements:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","LI","BLOCKQUOTE","OUTPUT","FIGCAPTION","PRE","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE","TD"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",center:"Center",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}};c.fn=a.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(g,h){this.rtePaste=false;this.$element=this.$source=a(g);this.uuid=d++;var j=a.extend(true,{},a.Redactor.opts);this.opts=a.extend({},j,this.$element.data(),h);this.start=true;this.dropdowns=[];this.sourceHeight=this.$source.css("height");this.sourceWidth=this.$source.css("width");if(this.opts.fullpage){this.opts.iframe=true}if(this.opts.linebreaks){this.opts.paragraphy=false}if(this.opts.paragraphy){this.opts.linebreaks=false}if(this.opts.toolbarFixedBox){this.opts.toolbarFixed=true}this.document=document;this.window=window;this.savedSel=false;this.cleanlineBefore=new RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=new RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]");this.cleannewLevel=new RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]");this.rTestBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(this.opts.linebreaks===false){if(this.opts.allowedTags!==false){var f=["strong","em","del"];var e=["b","i","strike"];if(a.inArray("p",this.opts.allowedTags)==="-1"){this.opts.allowedTags.push("p")}for(i in f){if(a.inArray(f[i],this.opts.allowedTags)!="-1"){this.opts.allowedTags.push(e[i])}}}if(this.opts.deniedTags!==false){var l=a.inArray("p",this.opts.deniedTags);if(l!=="-1"){this.opts.deniedTags.splice(l,l)}}}if(this.browser("msie")||this.browser("opera")){this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule")}this.opts.curLang=this.opts.langs[this.opts.lang];this.buildStart()},toolbarInit:function(e){return{html:{title:e.html,func:"toggle"},formatting:{title:e.formatting,func:"show",dropdown:{p:{title:e.paragraph,func:"formatBlocks"},blockquote:{title:e.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:e.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:e.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:e.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:e.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:e.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:e.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:e.bold,exec:"bold"},italic:{title:e.italic,exec:"italic"},deleted:{title:e.deleted,exec:"strikethrough"},underline:{title:e.underline,exec:"underline"},unorderedlist:{title:"&bull; "+e.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+e.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+e.outdent,func:"indentingOutdent"},indent:{title:"> "+e.indent,func:"indentingIndent"},image:{title:e.image,func:"imageShow"},video:{title:e.video,func:"videoShow"},file:{title:e.file,func:"fileShow"},table:{title:e.table,func:"show",dropdown:{insert_table:{title:e.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:e.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:e.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:e.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:e.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:e.add_head,func:"tableAddHead"},delete_head:{title:e.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:e.delete_column,func:"tableDeleteColumn"},delete_row:{title:e.delete_row,func:"tableDeleteRow"},delete_table:{title:e.delete_table,func:"tableDeleteTable"}}},link:{title:e.link,func:"show",dropdown:{link:{title:e.link_insert,func:"linkShow"},unlink:{title:e.unlink,exec:"unlink"}}},fontcolor:{title:e.fontcolor,func:"show"},backcolor:{title:e.backcolor,func:"show"},alignment:{title:e.alignment,func:"show",dropdown:{alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},justify:{title:e.align_justify,func:"alignmentJustify"}}},alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},alignjustify:{title:e.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:e.horizontalrule}}},callback:function(h,g,f){var e=this.opts[h+"Callback"];if(a.isFunction(e)){if(g===false){return e.call(this,f)}else{return e.call(this,g,f)}}else{return f}},destroy:function(){clearInterval(this.autosaveInterval);a(window).off(".redactor");this.$source.off("redactor-textarea");this.$element.off(".redactor").removeData("redactor");var f=this.get();if(this.opts.textareamode){this.$box.after(this.$source);this.$box.remove();this.$source.val(f).show()}else{var e=this.$editor;if(this.opts.iframe){e=this.$element}this.$box.after(e);this.$box.remove();e.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(f).show()}if(this.opts.toolbarExternal){a(this.opts.toolbarExternal).html("")}if(this.opts.air){a("#redactor_air_"+this.uuid).remove()}},getObject:function(){return a.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return(this.opts.iframe)?this.$frame:false},getToolbar:function(){return(this.$toolbar)?this.$toolbar:false},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var e=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:true,dir:this.opts.direction});return e},set:function(e,g,f){e=e.toString();e=e.replace(/\$/g,"&#36;");if(this.opts.fullpage){this.setCodeIframe(e)}else{this.setEditor(e,g)}if(e==""){f=false}if(f!==false){this.placeholderRemove()}},setEditor:function(e,f){if(f!==false){e=this.cleanSavePreCode(e);e=this.cleanStripTags(e);e=this.cleanConvertProtected(e);e=this.cleanConvertInlineTags(e,true);if(this.opts.linebreaks===false){e=this.cleanConverters(e)}else{e=e.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}}e=e.replace(/&amp;#36;/g,"$");e=this.cleanEmpty(e);this.$editor.html(e);this.setNonEditable();this.setSpansVerified();this.sync()},setCodeIframe:function(f){var e=this.iframePage();this.$frame[0].src="about:blank";f=this.cleanConvertProtected(f);f=this.cleanConvertInlineTags(f);f=this.cleanRemoveSpaces(f);e.open();e.write(f);e.close();if(this.opts.fullpage){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction})}this.setNonEditable();this.setSpansVerified();this.sync()},setFullpageOnInit:function(e){e=this.cleanSavePreCode(e,true);e=this.cleanConverters(e);e=this.cleanEmpty(e);this.$editor.html(e);this.setNonEditable();this.setSpansVerified();this.sync()},setSpansVerified:function(){var f=this.$editor.find("span");var e="inline";a.each(f,function(){var h=this.outerHTML;var j=new RegExp("<"+this.tagName,"gi");var g=h.replace(j,"<"+e);j=new RegExp("</"+this.tagName,"gi");g=g.replace(j,"</"+e);a(this).replaceWith(g)})},setSpansVerifiedHtml:function(e){e=e.replace(/<span(.*?)>/,"<inline$1>");return e.replace(/<\/span>/,"</inline>")},setNonEditable:function(){this.$editor.find(".noneditable").attr("contenteditable",false)},sync:function(){var f="";this.cleanUnverified();if(this.opts.fullpage){f=this.getCodeIframe()}else{f=this.$editor.html()}f=this.syncClean(f);f=this.cleanRemoveEmptyTags(f);var g=this.cleanRemoveSpaces(this.$source.val(),false);var e=this.cleanRemoveSpaces(f,false);if(g==e){return false}f=f.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");if(a.trim(f)==="<br>"){f=""}if(this.opts.xhtml){var h=["br","hr","img","link","input","meta"];a.each(h,function(j,l){f=f.replace(new RegExp("<"+l+"(.*?[^/$]?)>","gi"),"<"+l+"$1 />")})}f=this.callback("syncBefore",false,f);this.$source.val(f);this.callback("syncAfter",false,f);if(this.start===false){this.callback("change",false,f)}},syncClean:function(e){if(!this.opts.fullpage){e=this.cleanStripTags(e)}e=a.trim(e);e=this.placeholderRemoveFromCode(e);e=e.replace(/&#x200b;/gi,"");e=e.replace(/&#8203;/gi,"");e=e.replace(/<\/a>&nbsp;/gi,"</a> ");e=e.replace(/\u200B/g,"");if(e=="<p></p>"||e=="<p> </p>"||e=="<p>&nbsp;</p>"){e=""}if(this.opts.linkNofollow){e=e.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>");e=e.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">')}e=e.replace("<!--?php","<?php");e=e.replace("?-->","?>");e=e.replace(/<(.*?)class="noeditable"(.*?) contenteditable="false"(.*?)>/gi,'<$1class="noeditable"$2$3>');e=e.replace(/ data-tagblock=""/gi,"");e=e.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>");e=e.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/gi,"$3<img$4>");e=e.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/gi,"");e=e.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/gi,"");e=e.replace(/<(ul|ol|li)(.*?) style="(.*?)"(.*?)>/gi,"<$1$2$4>");e=e.replace(/<(ul|ol)>\s*\t*\n*<\/(ul|ol)>/gi,"");e=e.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2");e=e.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");e=e.replace(/<inline>/gi,"<span>");e=e.replace(/<inline /gi,"<span ");e=e.replace(/<\/inline>/gi,"</span>");e=e.replace(/<span(.*?)class="redactor_placeholder"(.*?)>([\w\W]*?)<\/span>/gi,"");e=e.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");e=e.replace(/&amp;/gi,"&");e=e.replace(/™/gi,"&trade;");e=e.replace(/©/gi,"&copy;");e=this.cleanReConvertProtected(e);return e},buildStart:function(){this.content="";this.$box=a('<div class="redactor_box" />');this.$box.css("z-index",100-this.uuid);if(this.$source[0].tagName==="TEXTAREA"){this.opts.textareamode=true}if(this.opts.mobile===false&&this.isMobile()){this.buildMobile()}else{this.buildContent();if(this.opts.iframe){this.opts.autoresize=false;this.iframeStart()}else{if(this.opts.textareamode){this.buildFromTextarea()}else{this.buildFromElement()}}if(!this.opts.iframe){this.buildOptions();this.buildAfter()}}},buildMobile:function(){if(!this.opts.textareamode){this.$editor=this.$source;this.$editor.hide();this.$source=this.buildCodearea(this.$editor);this.$source.val(this.content)}this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){if(this.opts.textareamode){this.content=a.trim(this.$source.val())}else{this.content=a.trim(this.$source.html())}},buildFromTextarea:function(){this.$editor=a("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(e){return a("<textarea />").attr("name",e.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(e){a.each(this.$source.get(0).className.split(/\s+/),function(f,g){e.addClass("redactor_"+g)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:true,dir:this.opts.direction});this.$source.attr("dir",this.opts.direction).hide();this.set(this.content,true,false)},buildOptions:function(){var e=this.$editor;if(this.opts.iframe){e=this.$frame}if(this.opts.tabindex){e.attr("tabindex",this.opts.tabindex)}if(this.opts.minHeight){e.css("min-height",this.opts.minHeight+"px")}if(this.opts.maxHeight){this.opts.autoresize=false;this.sourceHeight=this.opts.maxHeight}if(this.opts.wym){this.$editor.addClass("redactor_editor_wym")}if(this.opts.typewriter){this.$editor.addClass("redactor-editor-typewriter")}if(!this.opts.autoresize){e.css("height",this.sourceHeight)}},buildAfter:function(){this.start=false;if(this.opts.toolbar){this.opts.toolbar=this.toolbarInit(this.opts.curLang);this.toolbarBuild()}this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();if(this.opts.autosave){this.autosave()}setTimeout(a.proxy(this.observeStart,this),4);if(this.browser("mozilla")){try{this.document.execCommand("enableObjectResizing",false,false);this.document.execCommand("enableInlineTableEditing",false,false)}catch(f){}}if(this.opts.focus){setTimeout(a.proxy(this.focus,this),100)}if(!this.opts.visual){setTimeout(a.proxy(function(){this.opts.visual=true;this.toggle(false)},this),200)}this.callback("init")},buildBindKeyboard:function(){this.dblEnter=0;if(this.opts.dragUpload&&this.opts.imageUpload!==false){this.$editor.on("drop.redactor",a.proxy(this.buildEventDrop,this))}this.$editor.on("input.redactor",a.proxy(this.sync,this));this.$editor.on("paste.redactor",a.proxy(this.buildEventPaste,this));this.$editor.on("keydown.redactor",a.proxy(this.buildEventKeydown,this));this.$editor.on("keyup.redactor",a.proxy(this.buildEventKeyup,this));if(a.isFunction(this.opts.textareaKeydownCallback)){this.$source.on("keydown.redactor-textarea",a.proxy(this.opts.textareaKeydownCallback,this))}if(a.isFunction(this.opts.focusCallback)){this.$editor.on("focus.redactor",a.proxy(this.opts.focusCallback,this))}var e;a(document).mousedown(function(f){e=a(f.target)});this.$editor.on("blur.redactor",a.proxy(function(f){if(!a(e).hasClass("redactor_toolbar")&&a(e).parents(".redactor_toolbar").size()==0){this.selectall=false;if(a.isFunction(this.opts.blurCallback)){this.callback("blur",f)}}},this))},buildEventDrop:function(f){f=f.originalEvent||f;if(window.FormData===undefined||!f.dataTransfer){return true}var h=f.dataTransfer.files.length;if(h==0){return true}f.preventDefault();var g=f.dataTransfer.files[0];if(this.opts.dnbImageTypes!==false&&this.opts.dnbImageTypes.indexOf(g.type)==-1){return true}this.bufferSet();var j=a('<div id="redactor-progress"><span></span></div>');a(document.body).append(j);if(this.opts.s3===false){this.dragUploadAjax(this.opts.imageUpload,g,true,j,f,this.opts.imageUploadParam)}else{this.s3uploadFile(g)}},buildEventPaste:function(g){var j=false;if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){var f=this.browser("version").split(".");if(f[0]<536){j=true}}if(j){return true}if(this.browser("opera")){return true}if(this.opts.clipboardUpload&&this.buildEventClipboardUpload(g)){return true}if(this.opts.cleanup){this.rtePaste=true;this.selectionSave();if(!this.selectall){if(this.opts.autoresize===true&&this.fullscreen!==true){this.$editor.height(this.$editor.height());this.saveScroll=this.document.body.scrollTop}else{this.saveScroll=this.$editor.scrollTop()}}var h=this.extractContent();setTimeout(a.proxy(function(){var l=this.extractContent();this.$editor.append(h);this.selectionRestore();var e=this.getFragmentHtml(l);this.pasteClean(e);if(this.opts.autoresize===true&&this.fullscreen!==true){this.$editor.css("height","auto")}},this),1)}},buildEventClipboardUpload:function(f){var g=f.originalEvent||f;this.clipboardFilePaste=false;if(typeof(g.clipboardData)==="undefined"){return false}if(g.clipboardData.items){var h=g.clipboardData.items[0].getAsFile();if(h!==null){this.bufferSet();this.clipboardFilePaste=true;var j=new FileReader();j.onload=a.proxy(this.pasteClipboardUpload,this);j.readAsDataURL(h);return true}}return false},buildEventKeydown:function(j){if(this.rtePaste){return false}var m=j.which;var g=j.ctrlKey||j.metaKey;var p=this.getParent();var h=this.getCurrent();var f=this.getBlock();var q=false;this.callback("keydown",j);this.imageResizeHide(false);if((p&&a(p).get(0).tagName==="PRE")||(h&&a(h).get(0).tagName==="PRE")){q=true;if(m===this.keyCode.DOWN){this.insertAfterLastElement(f)}}if(m===this.keyCode.DOWN){if(p&&a(p)[0].tagName==="BLOCKQUOTE"){this.insertAfterLastElement(p)}if(h&&a(h)[0].tagName==="BLOCKQUOTE"){this.insertAfterLastElement(h)}if(p&&a(p)[0].tagName==="P"&&a(p).parent()[0].tagName=="BLOCKQUOTE"){this.insertAfterLastElement(p,a(p).parent()[0])}if(h&&a(h)[0].tagName==="P"&&p&&a(p)[0].tagName=="BLOCKQUOTE"){this.insertAfterLastElement(h,p)}}if(g&&!j.shiftKey){this.shortcuts(j,m)}if(g&&m===90&&!j.shiftKey&&!j.altKey){j.preventDefault();if(this.opts.buffer.length){this.bufferUndo()}else{this.document.execCommand("undo",false,false)}return}else{if(g&&m===90&&j.shiftKey&&!j.altKey){j.preventDefault();if(this.opts.rebuffer.length!=0){this.bufferRedo()}else{this.document.execCommand("redo",false,false)}return}}if(m==32){this.bufferSet()}if(g&&m===65){this.bufferSet();this.selectall=true}else{if(m!=this.keyCode.LEFT_WIN&&!g){this.selectall=false}}if(m==this.keyCode.ENTER&&!j.shiftKey&&!j.ctrlKey&&!j.metaKey){if(this.browser("msie")&&(p.nodeType==1&&(p.tagName=="TD"||p.tagName=="TH"))){j.preventDefault();this.bufferSet();this.insertNode(document.createElement("br"));this.callback("enter",j);return false}if(f&&(f.tagName=="BLOCKQUOTE"||a(f).parent()[0].tagName=="BLOCKQUOTE")){if(this.isEndOfElement()){if(this.dblEnter==1){var l;var n;if(f.tagName=="BLOCKQUOTE"){n="br";l=f}else{n="p";l=a(f).parent()[0]}j.preventDefault();this.insertingAfterLastElement(l);this.dblEnter=0;if(n=="p"){a(f).parent().find("p").last().remove()}else{var r=a.trim(a(f).html());a(f).html(r.replace(/<br\s?\/?>$/i,""))}return}else{this.dblEnter++}}else{this.dblEnter++}}if(q===true){return this.buildEventKeydownPre(j,h)}else{if(!this.opts.linebreaks){if(f&&this.opts.rBlockTest.test(f.tagName)){this.bufferSet();setTimeout(a.proxy(function(){var e=this.getBlock();if(e.tagName==="DIV"&&!a(e).hasClass("redactor_editor")){var s=a("<p>"+this.opts.invisibleSpace+"</p>");a(e).replaceWith(s);this.selectionStart(s)}},this),1)}else{if(f===false){this.bufferSet();var o=a("<p>"+this.opts.invisibleSpace+"</p>");this.insertNode(o[0]);this.selectionStart(o);this.callback("enter",j);return false}}}if(this.opts.linebreaks){if(f&&this.opts.rBlockTest.test(f.tagName)){this.bufferSet();setTimeout(a.proxy(function(){var e=this.getBlock();if((e.tagName==="DIV"||e.tagName==="P")&&!a(e).hasClass("redactor_editor")){this.replaceLineBreak(e)}},this),1)}else{return this.buildEventKeydownInsertLineBreak(j)}}if(f.tagName=="BLOCKQUOTE"||f.tagName=="FIGCAPTION"){return this.buildEventKeydownInsertLineBreak(j)}}this.callback("enter",j)}else{if(m===this.keyCode.ENTER&&(j.ctrlKey||j.shiftKey)){this.bufferSet();j.preventDefault();this.insertLineBreak()}}if(m===this.keyCode.TAB&&this.opts.shortcuts){return this.buildEventKeydownTab(j,q,m)}if(m===this.keyCode.BACKSPACE){this.buildEventKeydownBackspace(h)}},buildEventKeydownPre:function(g,f){g.preventDefault();this.bufferSet();var h=a(f).parent().text();this.insertNode(document.createTextNode("\n"));if(h.search(/\s$/)==-1){this.insertNode(document.createTextNode("\n"))}this.sync();this.callback("enter",g);return false},buildEventKeydownTab:function(f,h,g){if(!this.opts.tabFocus){return true}if(this.isEmpty(this.get())&&this.opts.tabSpaces===false){return true}f.preventDefault();if(h===true&&!f.shiftKey){this.bufferSet();this.insertNode(document.createTextNode("\t"));this.sync();return false}else{if(this.opts.tabSpaces!==false){this.bufferSet();this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join("\u00a0")));this.sync();return false}else{if(!f.shiftKey){this.indentingIndent()}else{this.indentingOutdent()}}}return false},buildEventKeydownBackspace:function(e){if(typeof e.tagName!=="undefined"&&/^(H[1-6])$/i.test(e.tagName)){var f;if(this.opts.linebreaks===false){f=a("<p>"+this.opts.invisibleSpace+"</p>")}else{f=a("<br>"+this.opts.invisibleSpace)}a(e).replaceWith(f);this.selectionStart(f)}if(typeof e.nodeValue!=="undefined"&&e.nodeValue!==null){if(e.remove&&e.nodeType===3&&e.nodeValue.match(/[^\u200B]/g)==null){e.remove()}}},buildEventKeydownInsertLineBreak:function(f){this.bufferSet();f.preventDefault();this.insertLineBreak();this.callback("enter",f);return},buildEventKeyup:function(g){if(this.rtePaste){return false}var h=g.which;var m=this.getParent();var f=this.getCurrent();if(!this.opts.linebreaks&&f.nodeType==3&&(m==false||m.tagName=="BODY")){var l=a("<p>").append(a(f).clone());a(f).replaceWith(l);var j=a(l).next();if(typeof(j[0])!=="undefined"&&j[0].tagName=="BR"){j.remove()}this.selectionEnd(l)}if((this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&h===this.keyCode.ENTER){this.buildEventKeyupConverters()}if(h===this.keyCode.DELETE||h===this.keyCode.BACKSPACE){return this.formatEmpty(g)}this.callback("keyup",g);this.sync()},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize);setTimeout(a.proxy(function(){if(this.opts.convertImageLinks){this.observeImages()}if(this.opts.observeLinks){this.observeLinks()}},this),5)},buildPlugins:function(){if(!this.opts.plugins){return}a.each(this.opts.plugins,a.proxy(function(e,f){if(RedactorPlugins[f]){a.extend(this,RedactorPlugins[f]);if(a.isFunction(RedactorPlugins[f].init)){this.init()}}},this))},iframeStart:function(){this.iframeCreate();if(this.opts.textareamode){this.iframeAppend(this.$source)}else{this.$sourceOld=this.$source.hide();this.$source=this.buildCodearea(this.$sourceOld);this.iframeAppend(this.$sourceOld)}},iframeAppend:function(e){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(e).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=a('<iframe style="width: 100%;" frameborder="0" />').one("load",a.proxy(function(){if(this.opts.fullpage){this.iframePage();if(this.content===""){this.content=this.opts.invisibleSpace}this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var e=setInterval(a.proxy(function(){if(this.$frame.contents().find("body").html()){clearInterval(e);this.iframeLoad()}},this),0)}else{this.iframeLoad()}},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var e=this.iframeDoc();if(e.documentElement){e.removeChild(e.documentElement)}return e},iframeAddCss:function(e){e=e||this.opts.css;if(this.isString(e)){this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+e+'" />')}if(a.isArray(e)){a.each(e,a.proxy(function(f,g){this.iframeAddCss(g)},this))}},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction});if(this.$editor[0]){this.document=this.$editor[0].ownerDocument;this.window=this.document.defaultView||window}this.iframeAddCss();if(this.opts.fullpage){this.setFullpageOnInit(this.$editor.html())}else{this.set(this.content,true,false)}this.buildOptions();this.buildAfter()},placeholderStart:function(e){if(this.isEmpty(e)){if(this.$element.attr("placeholder")){this.opts.placeholder=this.$element.attr("placeholder")}if(this.opts.placeholder===""){this.opts.placeholder=false}if(this.opts.placeholder!==false){this.opts.focus=false;this.placeholderEvents();return this.placeholderGet()}}return false},placeholderEvents:function(){this.$editor.on("focus.redactor_placeholder",a.proxy(this.placeholderFocus,this));this.$editor.on("blur.redactor_placeholder",a.proxy(this.placeholderBlur,this))},placeholderGet:function(){return a('<span class="redactor_placeholder">').data("redactor","verified").attr("contenteditable",false).text(this.opts.placeholder)},placeholderBlur:function(){var e=this.get();if(this.isEmpty(e)){this.$editor.on("focus.redactor_placeholder",a.proxy(this.placeholderFocus,this));this.$editor.html(this.placeholderGet())}},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var e="";if(this.opts.linebreaks===false){e=this.opts.emptyHtml}this.$editor.off("focus.redactor_placeholder");this.$editor.html(e);if(this.opts.linebreaks===false){this.selectionStart(this.$editor.children()[0])}else{this.focus()}this.sync()},placeholderRemove:function(){this.opts.placeholder=false;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(e){return e.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,"")},shortcuts:function(f,g){if(!this.opts.shortcuts){return}if(!f.altKey){if(g===77){this.shortcutsLoad(f,"removeFormat")}else{if(g===66){this.shortcutsLoad(f,"bold")}else{if(g===73){this.shortcutsLoad(f,"italic")}else{if(g===74){this.shortcutsLoad(f,"insertunorderedlist")}else{if(g===75){this.shortcutsLoad(f,"insertorderedlist")}else{if(g===72){this.shortcutsLoad(f,"superscript")}else{if(g===76){this.shortcutsLoad(f,"subscript")}}}}}}}}else{if(g===48){this.shortcutsLoadFormat(f,"p")}else{if(g===49){this.shortcutsLoadFormat(f,"h1")}else{if(g===50){this.shortcutsLoadFormat(f,"h2")}else{if(g===51){this.shortcutsLoadFormat(f,"h3")}else{if(g===52){this.shortcutsLoadFormat(f,"h4")}else{if(g===53){this.shortcutsLoadFormat(f,"h5")}else{if(g===54){this.shortcutsLoadFormat(f,"h6")}}}}}}}}},shortcutsLoad:function(g,f){g.preventDefault();this.execCommand(f,false)},shortcutsLoadFormat:function(g,f){g.preventDefault();this.formatBlocks(f)},focus:function(){if(!this.browser("opera")){this.window.setTimeout(a.proxy(this.focusSet,this,true),1)}else{this.$editor.focus()}},focusWithSaveScroll:function(){if(this.browser("msie")){var e=this.document.documentElement.scrollTop}this.$editor.focus();if(this.browser("msie")){this.document.documentElement.scrollTop=e}},focusEnd:function(){if(!this.browser("mozilla")){this.focusSet()}else{if(this.opts.linebreaks===false){var e=this.$editor.children().last();this.$editor.focus();this.selectionEnd(e)}else{this.focusSet()}}},focusSet:function(e,f){this.$editor.focus();if(typeof f=="undefined"){f=this.$editor[0]}var g=this.getRange();g.selectNodeContents(f);g.collapse(e||false);var h=this.getSelection();h.removeAllRanges();h.addRange(g)},toggle:function(e){if(this.opts.visual){this.toggleCode(e)}else{this.toggleVisual()}},toggleVisual:function(){var e=this.$source.hide().val();if(typeof this.modified!=="undefined"){this.modified=this.cleanRemoveSpaces(this.modified,false)!==this.cleanRemoveSpaces(e,false)}if(this.modified){if(this.opts.fullpage&&e===""){this.setFullpageOnInit(e)}else{this.set(e);if(this.opts.fullpage){this.buildBindKeyboard()}}}if(this.opts.iframe){this.$frame.show()}else{this.$editor.show()}if(this.opts.fullpage){this.$editor.attr("contenteditable",true)}this.$source.off("keydown.redactor-textarea-indenting");this.$editor.focus();this.selectionRestore();this.observeStart();this.buttonActiveVisual();this.buttonInactive("html");this.opts.visual=true},toggleCode:function(e){if(e!==false){this.selectionSave()}var f=null;if(this.opts.iframe){f=this.$frame.height();if(this.opts.fullpage){this.$editor.removeAttr("contenteditable")}this.$frame.hide()}else{f=this.$editor.innerHeight();this.$editor.hide()}var g=this.$source.val();if(g!==""&&this.opts.tidyHtml){this.$source.val(this.cleanHtml(g))}this.modified=g;this.$source.height(f).show().focus();this.$source.on("keydown.redactor-textarea-indenting",this.textareaIndenting);this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=false},textareaIndenting:function(g){if(g.keyCode===9){var f=a(this);var h=f.get(0).selectionStart;f.val(f.val().substring(0,h)+"\t"+f.val().substring(f.get(0).selectionEnd));f.get(0).selectionStart=f.get(0).selectionEnd=h+1;return false}},autosave:function(){var e=false;this.autosaveInterval=setInterval(a.proxy(function(){var f=this.get();if(e!==f){a.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(f)),success:a.proxy(function(g){this.callback("autosave",false,g);e=f},this)})}},this),this.opts.autosaveInterval*1000)},toolbarBuild:function(){if(this.isMobile()&&this.opts.buttonsHideOnMobile.length>0){a.each(this.opts.buttonsHideOnMobile,a.proxy(function(f,h){var g=this.opts.buttons.indexOf(h);this.opts.buttons.splice(g,1)},this))}if(this.opts.air){this.opts.buttons=this.opts.airButtons}else{if(!this.opts.buttonSource){var e=this.opts.buttons.indexOf("html");this.opts.buttons.splice(e,1)}}if(this.opts.toolbar){a.each(this.opts.toolbar.formatting.dropdown,a.proxy(function(f,g){if(a.inArray(f,this.opts.formattingTags)=="-1"){delete this.opts.toolbar.formatting.dropdown[f]}},this))}if(this.opts.buttons.length===0){return false}this.airEnable();this.$toolbar=a("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid);if(this.opts.typewriter){this.$toolbar.addClass("redactor-toolbar-typewriter")}if(this.opts.toolbarOverflow&&this.isMobile()){this.$toolbar.addClass("redactor-toolbar-overflow")}if(this.opts.air){this.$air=a('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide();this.$air.append(this.$toolbar);a("body").append(this.$air)}else{if(this.opts.toolbarExternal){this.$toolbar.addClass("redactor-toolbar-external");a(this.opts.toolbarExternal).html(this.$toolbar)}else{this.$box.prepend(this.$toolbar)}}a.each(this.opts.buttons,a.proxy(function(h,f){if(this.opts.toolbar[f]){var g=this.opts.toolbar[f];if(this.opts.fileUpload===false&&f==="file"){return true}this.$toolbar.append(a("<li>").append(this.buttonBuild(f,g)))}},this));this.$toolbar.find("a").attr("tabindex","-1");if(this.opts.toolbarFixed){this.toolbarObserveScroll();a(this.opts.toolbarFixedTarget).on("scroll.redactor",a.proxy(this.toolbarObserveScroll,this))}if(this.opts.activeButtons){this.$editor.on("mouseup.redactor keyup.redactor",a.proxy(this.buttonActiveObserver,this))}},toolbarObserveScroll:function(){var h=a(this.opts.toolbarFixedTarget).scrollTop();var e=this.$box.offset().top;var g=0;var f=e+this.$box.height()+40;if(h>e){var j="100%";if(this.opts.toolbarFixedBox){g=this.$box.offset().left;j=this.$box.innerWidth();this.$toolbar.addClass("toolbar_fixed_box")}this.toolbarFixed=true;this.$toolbar.css({position:"fixed",width:j,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:g});if(h<f){this.$toolbar.css("visibility","visible")}else{this.$toolbar.css("visibility","hidden")}}else{this.toolbarFixed=false;this.$toolbar.css({position:"relative",width:"auto",top:0,left:g});if(this.opts.toolbarFixedBox){this.$toolbar.removeClass("toolbar_fixed_box")}}},airEnable:function(){if(!this.opts.air){return}this.$editor.on("mouseup.redactor keyup.redactor",this,a.proxy(function(g){var j=this.getSelectionText();if(g.type==="mouseup"&&j!=""){this.airShow(g)}if(g.type==="keyup"&&g.shiftKey&&j!=""){var f=a(this.getElement(this.getSelection().focusNode)),h=f.offset();h.height=f.height();this.airShow(h,true)}},this))},airShow:function(f,g){if(!this.opts.air){return}var h,j;a(".redactor_air").hide();if(g){h=f.left;j=f.top+f.height+14;if(this.opts.iframe){j+=this.$box.position().top-a(this.document).scrollTop();h+=this.$box.position().left}}else{var l=this.$air.innerWidth();h=f.clientX;if(a(this.document).width()<(h+l)){h-=l}j=f.clientY+14;if(this.opts.iframe){j+=this.$box.position().top;h+=this.$box.position().left}else{j+=a(this.document).scrollTop()}}this.$air.css({left:h+"px",top:j+"px"}).show();this.airBindHide()},airBindHide:function(){if(!this.opts.air){return}var e=a.proxy(function(f){a(f).on("mousedown.redactor",a.proxy(function(g){if(a(g.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);this.selectionRemove();a(f).off(g)}},this)).on("keydown.redactor",a.proxy(function(g){if(g.which===this.keyCode.ESC){this.getSelection().collapseToStart()}this.$air.fadeOut(100);a(f).off(g)},this))},this);e(document);if(this.opts.iframe){e(this.document)}},airBindMousemoveHide:function(){if(!this.opts.air){return}var e=a.proxy(function(f){a(f).on("mousemove.redactor",a.proxy(function(g){if(a(g.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);a(f).off(g)}},this))},this);e(document);if(this.opts.iframe){e(this.document)}},dropdownBuild:function(e,f){a.each(f,a.proxy(function(h,j){if(!j.className){j.className=""}var g;if(j.name==="separator"){g=a('<a class="redactor_separator_drop">')}else{g=a('<a href="#" class="'+j.className+" redactor_dropdown_"+h+'">'+j.title+"</a>");g.on("click",a.proxy(function(l){if(l.preventDefault){l.preventDefault()}if(this.browser("msie")){l.returnValue=false}if(j.callback){j.callback.call(this,h,g,j,l)}if(j.exec){this.execCommand(j.exec,h)}if(j.func){this[j.func](h)}this.buttonActiveObserver();if(this.opts.air){this.$air.fadeOut(100)}},this))}e.append(g)},this))},dropdownShow:function(l,n){if(!this.opts.visual){l.preventDefault();return false}var g=this.$toolbar.find(".redactor_dropdown_box_"+n);var f=this.buttonGet(n);if(f.hasClass("dropact")){this.dropdownHideAll()}else{this.dropdownHideAll();this.buttonActive(n);f.addClass("dropact");var o=f.position();if(this.toolbarFixed){o=f.offset()}var j=g.width();if((o.left+j)>a(document).width()){o.left-=j}var p=o.left+"px";var h=f.innerHeight();var q="absolute";var r=h+"px";if(this.opts.toolbarFixed&&this.toolbarFixed){q="fixed"}else{if(!this.opts.air){r=o.top+h+"px"}}g.css({position:q,left:p,top:r}).show()}var m=a.proxy(function(s){this.dropdownHide(s,g)},this);a(document).one("click",m);this.$editor.one("click",m);l.stopPropagation();this.focusWithSaveScroll()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");a(".redactor_dropdown").hide()},dropdownHide:function(g,f){if(!a(g.target).hasClass("dropact")){f.removeClass("dropact");this.dropdownHideAll()}},buttonBuild:function(g,h,j){var e=a('<a href="javascript:;" title="'+h.title+'" tabindex="-1" class="re-icon re-'+g+'"></a>');if(typeof j!="undefined"){e.addClass("redactor-btn-image")}e.on("click",a.proxy(function(l){if(l.preventDefault){l.preventDefault()}if(this.browser("msie")){l.returnValue=false}if(e.hasClass("redactor_button_disabled")){return false}if(this.isFocused()===false&&!h.exec){this.focusWithSaveScroll()}if(h.exec){this.focusWithSaveScroll();this.execCommand(h.exec,g);this.airBindMousemoveHide()}else{if(h.func&&h.func!=="show"){this[h.func](g);this.airBindMousemoveHide()}else{if(h.callback){h.callback.call(this,g,e,h,l);this.airBindMousemoveHide()}else{if(h.dropdown){this.dropdownShow(l,g)}}}}this.buttonActiveObserver(false,g)},this));if(h.dropdown){var f=a('<div class="redactor_dropdown redactor_dropdown_box_'+g+'" style="display: none;">');f.appendTo(this.$toolbar);this.dropdownBuild(f,h.dropdown)}return e},buttonGet:function(e){if(!this.opts.toolbar){return false}return a(this.$toolbar.find("a.re-"+e))},buttonTagToActiveState:function(e,f){this.opts.activeButtons.push(e);this.opts.activeButtonsStates[f]=e},buttonActiveToggle:function(f){var e=this.buttonGet(f);if(e.hasClass("redactor_act")){this.buttonInactive(f)}else{this.buttonActive(f)}},buttonActive:function(f){var e=this.buttonGet(f);e.addClass("redactor_act")},buttonInactive:function(f){var e=this.buttonGet(f);e.removeClass("redactor_act")},buttonInactiveAll:function(e){this.$toolbar.find("a.re-icon").not(".re-"+e).removeClass("redactor_act")},buttonActiveVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").addClass("redactor_button_disabled")},buttonChangeIcon:function(f,e){this.buttonGet(f).addClass("re-"+e)},buttonRemoveIcon:function(f,e){this.buttonGet(f).removeClass("re-"+e)},buttonAwesome:function(f,g){var e=this.buttonGet(f);e.removeClass("redactor-btn-image");e.addClass("fa-redactor-btn");e.html('<i class="fa '+g+'"></i>')},buttonAdd:function(h,j,f,g){if(!this.opts.toolbar){return}var e=this.buttonBuild(h,{title:j,callback:f,dropdown:g},true);this.$toolbar.append(a("<li>").append(e))},buttonAddFirst:function(h,j,f,g){if(!this.opts.toolbar){return}var e=this.buttonBuild(h,{title:j,callback:f,dropdown:g},true);this.$toolbar.prepend(a("<li>").append(e))},buttonAddAfter:function(f,l,m,h,j){if(!this.opts.toolbar){return}var g=this.buttonBuild(l,{title:m,callback:h,dropdown:j},true);var e=this.buttonGet(f);if(e.size()!==0){e.parent().after(a("<li>").append(g))}else{this.$toolbar.append(a("<li>").append(g))}},buttonAddBefore:function(f,l,m,h,j){if(!this.opts.toolbar){return}var g=this.buttonBuild(l,{title:m,callback:h,dropdown:j},true);var e=this.buttonGet(f);if(e.size()!==0){e.parent().before(a("<li>").append(g))}else{this.$toolbar.append(a("<li>").append(g))}},buttonRemove:function(f){var e=this.buttonGet(f);e.remove()},buttonActiveObserver:function(j,h){var l=this.getParent();this.buttonInactiveAll(h);if(j===false&&h!=="html"){if(a.inArray(h,this.opts.activeButtons)!=-1){this.buttonActiveToggle(h)}return}if(l&&l.tagName==="A"){this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit)}else{this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert)}a.each(this.opts.activeButtonsStates,a.proxy(function(e,m){if(a(l).closest(e,this.$editor.get()[0]).length!=0){this.buttonActive(m)}},this));var f=a(l).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(f.length){var g=f.css("text-align");switch(g){case"right":this.buttonActive("alignright");break;case"center":this.buttonActive("aligncenter");break;case"justify":this.buttonActive("alignjustify");break;default:this.buttonActive("alignleft");break}}},execPasteFrag:function(h){var m=this.window.getSelection();if(m.getRangeAt&&m.rangeCount){range=m.getRangeAt(0);range.deleteContents();var e=document.createElement("div");e.innerHTML=h;var g=document.createDocumentFragment(),l,j;while((l=e.firstChild)){j=g.appendChild(l)}var f=g.firstChild;range.insertNode(g);if(j){range=range.cloneRange();range.setStartAfter(j);range.collapse(true)}m.removeAllRanges();m.addRange(range)}},exec:function(e,f,g){if(e==="formatblock"&&this.browser("msie")){f="<"+f+">"}if(e==="inserthtml"&&this.browser("msie")){if(!this.isIe11()){this.focusWithSaveScroll();this.document.selection.createRange().pasteHTML(f)}else{this.execPasteFrag(f)}}else{this.document.execCommand(e,false,f)}if(g!==false){this.sync()}this.callback("execCommand",e,f)},execCommand:function(e,f,h){if(!this.opts.visual){this.$source.focus();return false}if(e==="superscript"||e==="subscript"){var g=this.getParent();if(g.tagName==="SUP"||g.tagName==="SUB"){this.inlineRemoveFormatReplace(g)}}if(e==="inserthtml"){this.insertHtml(f,h);this.callback("execCommand",e,f);return}if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre){return false}if(e==="insertunorderedlist"||e==="insertorderedlist"){return this.execLists(e,f)}if(e==="unlink"){return this.execUnlink(e,f)}this.exec(e,f,h);if(e==="inserthorizontalrule"){this.$editor.find("hr").removeAttr("id")}},execUnlink:function(e,g){this.bufferSet();var f=this.currentOrParentIs("A");if(f){a(f).replaceWith(a(f).text());this.sync();this.callback("execCommand",e,g);return}},execLists:function(g,o){this.bufferSet();var p=this.getParent();var e=a(p).closest("ol, ul");if(!this.isParentRedactor(e)&&e.size()!=0){e=false}var q=false;if(e&&e.length){q=true;var m=e[0].tagName;if((g==="insertunorderedlist"&&m==="OL")||(g==="insertorderedlist"&&m==="UL")){q=false}}this.selectionSave();if(q){var n=this.getNodes();var j=this.getBlocks(n);if(typeof n[0]!="undefined"&&n.length>1&&n[0].nodeType==3){j.unshift(this.getBlock())}var h="",r="";a.each(j,a.proxy(function(v,w){if(w.tagName=="LI"){var t=a(w);var u=t.clone();u.find("ul","ol").remove();if(this.opts.linebreaks===false){h+=this.outerHtml(a("<p>").append(u.contents()))}else{h+=u.html()+"<br>"}if(v==0){t.addClass("redactor-replaced").empty();r=this.outerHtml(t)}else{t.remove()}}},this));html=this.$editor.html().replace(r,"</"+m+">"+h+"<"+m+">");this.$editor.html(html);this.$editor.find(m+":empty").remove()}else{var l=a(this.getParent()).closest("td");this.document.execCommand(g);var p=this.getParent();var e=a(p).closest("ol, ul");if(l.size()!=0){e.wrapAll("<td>")}if(e.length){var f=e.parent();if(this.isParentRedactor(f)&&f[0].tagName!="LI"&&this.nodeTestBlocks(f[0])){f.replaceWith(f.contents())}}if(this.browser("mozilla")){this.$editor.focus()}}this.selectionRestore();this.sync();this.callback("execCommand",g,o);return},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(g){this.bufferSet();if(g==="indent"){var f=this.getBlock();this.selectionSave();if(f&&f.tagName=="LI"){var p=this.getParent();var e=a(p).closest("ol, ul");var n=e[0].tagName;var j=this.getBlocks();a.each(j,function(t,u){if(u.tagName=="LI"){var r=a(u).prev();if(r.size()!=0&&r[0].tagName=="LI"){var q=r.children("ul, ol");if(q.size()==0){r.append(a("<"+n+">").append(u))}else{q.append(u)}}}})}else{if(f===false&&this.opts.linebreaks===true){this.exec("formatBlock","blockquote");var o=this.getBlock();var f=a('<div data-tagblock="">').html(a(o).html());a(o).replaceWith(f);var m=this.normalize(a(f).css("margin-left"))+this.opts.indentValue;a(f).css("margin-left",m+"px")}else{var h=this.getBlocks();a.each(h,a.proxy(function(s,r){var q=false;if(r.tagName==="TD"){return}if(a.inArray(r.tagName,this.opts.alignmentTags)!==-1){q=a(r)}else{q=a(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var t=this.normalize(q.css("margin-left"))+this.opts.indentValue;q.css("margin-left",t+"px")},this))}}this.selectionRestore()}else{this.selectionSave();var f=this.getBlock();if(f&&f.tagName=="LI"){var j=this.getBlocks();var l=0;this.insideOutdent(f,l,j)}else{var h=this.getBlocks();a.each(h,a.proxy(function(s,r){var q=false;if(a.inArray(r.tagName,this.opts.alignmentTags)!==-1){q=a(r)}else{q=a(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var t=this.normalize(q.css("margin-left"))-this.opts.indentValue;if(t<=0){if(this.opts.linebreaks===true&&typeof(q.data("tagblock"))!=="undefined"){q.replaceWith(q.html())}else{q.css("margin-left","");this.removeEmptyAttr(q,"style")}}else{q.css("margin-left",t+"px")}},this))}this.selectionRestore()}this.sync()},insideOutdent:function(h,g,f){if(h&&h.tagName=="LI"){var e=a(h).parent().parent();if(e.size()!=0&&e[0].tagName=="LI"){e.after(h)}else{if(typeof f[g]!="undefined"){h=f[g];g++;this.insideOutdent(h,g,f)}else{this.execCommand("insertunorderedlist")}}}},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(j,f){this.bufferSet();if(this.oldIE()){this.document.execCommand(f,false,false);return true}this.selectionSave();var e=this.getBlock();if(!e&&this.opts.linebreaks){this.exec("formatBlock","blockquote");var h=this.getBlock();var e=a('<div data-tagblock="">').html(a(h).html());a(h).replaceWith(e);a(e).css("text-align",j);this.removeEmptyAttr(e,"style");if(j==""&&typeof(a(e).data("tagblock"))!=="undefined"){a(e).replaceWith(a(e).html())}}else{var g=this.getBlocks();a.each(g,a.proxy(function(n,m){var l=false;if(a.inArray(m.tagName,this.opts.alignmentTags)!==-1){l=a(m)}else{l=a(m).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}if(l){l.css("text-align",j);this.removeEmptyAttr(l,"style")}},this))}this.selectionRestore();this.sync()},cleanEmpty:function(e){var f=this.placeholderStart(e);if(f!==false){return f}if(this.opts.linebreaks===false){if(e===""){e=this.opts.emptyHtml}else{if(e.search(/^<hr\s?\/?>$/gi)!==-1){e="<hr>"+this.opts.emptyHtml}}}return e},cleanConverters:function(e){if(this.opts.convertDivs){e=e.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")}if(this.opts.paragraphy){e=this.cleanParagraphy(e)}return e},cleanConvertProtected:function(e){if(this.opts.templateVars){e=e.replace(/\{\{(.*?)\}\}/gi,"<!-- template double $1 -->");e=e.replace(/\{(.*?)\}/gi,"<!-- template $1 -->")}e=e.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');e=e.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>');e=e.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');if(this.opts.phpTags){e=e.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>')}else{e=e.replace(/<\?php([\w\W]*?)\?>/gi,"")}return e},cleanReConvertProtected:function(e){if(this.opts.templateVars){e=e.replace(/<!-- template double (.*?) -->/gi,"{{$1}}");e=e.replace(/<!-- template (.*?) -->/gi,"{$1}")}e=e.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2</script>');e=e.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>");e=e.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>");if(this.opts.phpTags){e=e.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>")}return e},cleanRemoveSpaces:function(f,e){if(e!==false){var e=[];var g=f.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);if(g===null){g=[]}if(this.opts.phpTags){var h=f.match(/<\?php([\w\W]*?)\?>/gi);if(h){g=a.merge(g,h)}}if(g){a.each(g,function(j,l){f=f.replace(l,"buffer_"+j);e.push(l)})}}f=f.replace(/\n/g," ");f=f.replace(/[\t]*/g,"");f=f.replace(/\n\s*\n/g,"\n");f=f.replace(/^[\s\n]*/g," ");f=f.replace(/[\s\n]*$/g," ");f=f.replace(/>\s{2,}</g,"> <");f=this.cleanReplacer(f,e);f=f.replace(/\n\n/g,"\n");return f},cleanReplacer:function(f,e){if(e===false){return f}a.each(e,function(g,h){f=f.replace("buffer_"+g,h)});return f},cleanRemoveEmptyTags:function(g){g=g.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");g=g.replace(/[\u200B-\u200D\uFEFF]/g,"");var f=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"];var e=["<pre></pre>","<blockquote>\\s*</blockquote>","<dd></dd>","<dt></dt>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<p>\\s*</p>","<p></p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];if(this.opts.removeEmptyTags){e=e.concat(f)}else{e=f}var j=e.length;for(var h=0;h<j;++h){g=g.replace(new RegExp(e[h],"gi"),"")}return g},cleanParagraphy:function(g){g=a.trim(g);if(this.opts.linebreaks===true){return g}if(g===""||g==="<p></p>"){return this.opts.emptyHtml}g=g+"\n";var o=[];var l=g.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);if(!l){l=[]}var f=g.match(/<!--([\w\W]*?)-->/gi);if(f){l=a.merge(l,f)}if(this.opts.phpTags){var m=g.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi);if(m){l=a.merge(l,m)}}if(l){a.each(l,function(p,q){o[p]=q;g=g.replace(q,"{replace"+p+"}\n")})}g=g.replace(/<br \/>\s*<br \/>/gi,"\n\n");function n(s,p,q){return g.replace(new RegExp(s,p),q)}var e="(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)";g=n("(<"+e+"[^>]*>)","gi","\n$1");g=n("(</"+e+">)","gi","$1\n\n");g=n("\r\n","g","\n");g=n("\r","g","\n");g=n("/\n\n+/","g","\n\n");var h=g.split(new RegExp("\ns*\n","g"),-1);g="";for(var j in h){if(h.hasOwnProperty(j)){if(h[j].search("{replace")==-1){h[j]=h[j].replace(/<p>\n\t<\/p>/gi,"");h[j]=h[j].replace(/<p><\/p>/gi,"");if(h[j]!=""){g+="<p>"+h[j].replace(/^\n+|\n+$/g,"")+"</p>"}}else{g+=h[j]}}}g=n("<p><p>","gi","<p>");g=n("</p></p>","gi","</p>");g=n("<p>s?</p>","gi","");g=n("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");g=n("<p>(</?"+e+"[^>]*>)</p>","gi","$1");g=n("<p>(<li.+?)</p>","gi","$1");g=n("<p>s?(</?"+e+"[^>]*>)","gi","$1");g=n("(</?"+e+"[^>]*>)s?</p>","gi","$1");g=n("(</?"+e+"[^>]*>)s?<br />","gi","$1");g=n("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");g=n("\n</p>","gi","</p>");g=n("<li><p>","gi","<li>");g=n("</p></li>","gi","</li>");g=n("</li><p>","gi","</li>");g=n("<p>\t?\n?<p>","gi","<p>");g=n("</dt><p>","gi","</dt>");g=n("</dd><p>","gi","</dd>");g=n("<br></p></blockquote>","gi","</blockquote>");g=n("<p>\t*</p>","gi","");a.each(o,function(p,q){g=g.replace("{replace"+p+"}",q)});return a.trim(g)},cleanConvertInlineTags:function(f,h){var e="strong";if(this.opts.boldTag==="b"){e="b"}var g="em";if(this.opts.italicTag==="i"){g="i"}f=f.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+g+">$1</"+g+">");f=f.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+e+">$1</"+e+">");if(this.opts.boldTag==="strong"){f=f.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>")}else{f=f.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>")}if(this.opts.italicTag==="em"){f=f.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>")}else{f=f.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>")}if(h!==true){f=f.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>")}else{f=f.replace(/<del>([\w\W]*?)<\/del>/gi,"<strike>$1</strike>")}return f},cleanStripTags:function(g){if(g==""||typeof g=="undefined"){return g}var e=false;if(this.opts.allowedTags!==false){e=true}var f=e===true?this.opts.allowedTags:this.opts.deniedTags;var h=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;g=g.replace(h,function(j,l){if(e===true){return a.inArray(l.toLowerCase(),f)>"-1"?j:""}else{return a.inArray(l.toLowerCase(),f)>"-1"?"":j}});g=this.cleanConvertInlineTags(g);return g},cleanSavePreCode:function(f,e){var g=f.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);if(g!==null){a.each(g,a.proxy(function(j,l){var h=l.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);h[3]=h[3].replace(/&nbsp;/g," ");if(e!==false){h[3]=this.cleanEncodeEntities(h[3])}h[3]=h[3].replace(/\$/g,"&#36;");f=f.replace(l,"<"+h[1]+h[2]+">"+h[3]+"</"+h[1]+">")},this))}return f},cleanEncodeEntities:function(e){e=String(e).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var e=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");e.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");e.filter('[style*="background-color: transparent;"]').css("background-color","");e.css("line-height","");a.each(e,a.proxy(function(f,g){this.removeEmptyAttr(g,"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(e){var j=0,f=e.length,m=0,n=null,h=null,p="",l="",g="";this.cleanlevel=0;for(;j<f;j++){m=j;if(-1==e.substr(j).indexOf("<")){l+=e.substr(j);return this.cleanFinish(l)}while(m<f&&e.charAt(m)!="<"){m++}if(j!=m){g=e.substr(j,m-j);if(!g.match(/^\s{2,}$/g)){if("\n"==l.charAt(l.length-1)){l+=this.cleanGetTabs()}else{if("\n"==g.charAt(0)){l+="\n"+this.cleanGetTabs();g=g.replace(/^\s+/,"")}}l+=g}if(g.match(/\n/)){l+="\n"+this.cleanGetTabs()}}n=m;while(m<f&&">"!=e.charAt(m)){m++}p=e.substr(n,m-n);j=m;var o;if("!--"==p.substr(1,3)){if(!p.match(/--$/)){while("-->"!=e.substr(m,3)){m++}m+=2;p=e.substr(n,m-n);j=m}if("\n"!=l.charAt(l.length-1)){l+="\n"}l+=this.cleanGetTabs();l+=p+">\n"}else{if("!"==p[1]){l=this.placeTag(p+">",l)}else{if("?"==p[1]){l+=p+">\n"}else{if(o=p.match(/^<(script|style|pre)/i)){o[1]=o[1].toLowerCase();p=this.cleanTag(p);l=this.placeTag(p,l);h=String(e.substr(j+1)).toLowerCase().indexOf("</"+o[1]);if(h){g=e.substr(j+1,h);j+=h;l+=g}}else{p=this.cleanTag(p);l=this.placeTag(p,l)}}}}}return this.cleanFinish(l)},cleanGetTabs:function(){var f="";for(var e=0;e<this.cleanlevel;e++){f+="\t"}return f},cleanFinish:function(e){e=e.replace(/\n\s*\n/g,"\n");e=e.replace(/^[\s\n]*/,"");e=e.replace(/[\s\n]*$/,"");e=e.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>");this.cleanlevel=0;return e},cleanTag:function(g){var h="";g=g.replace(/\n/g," ");g=g.replace(/\s{2,}/g," ");g=g.replace(/^\s+|\s+$/g," ");var f="";if(g.match(/\/$/)){f="/";g=g.replace(/\/+$/,"")}var e;while(e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(g)){if(e[2]){h+=e[1].toLowerCase()+"="+e[2]}else{if(e[1]){h+=e[1].toLowerCase()}}h+=" ";g=g.substr(e[0].length)}return h.replace(/\s*$/,"")+f+">"},placeTag:function(g,f){var e=g.match(this.cleannewLevel);if(g.match(this.cleanlineBefore)||e){f=f.replace(/\s*$/,"");f+="\n"}if(e&&"/"==g.charAt(1)){this.cleanlevel--}if("\n"==f.charAt(f.length-1)){f+=this.cleanGetTabs()}if(e&&"/"!=g.charAt(1)){this.cleanlevel++}f+=g;if(g.match(this.cleanlineAfter)||g.match(this.cleannewLevel)){f=f.replace(/ *$/,"");f+="\n"}return f},formatEmpty:function(f){var g=a.trim(this.$editor.html());if(this.opts.linebreaks){if(g==""){f.preventDefault();this.$editor.html("");this.focus()}}else{g=g.replace(/<br\s?\/?>/i,"");var j=g.replace(/<p>\s?<\/p>/gi,"");if(g===""||j===""){f.preventDefault();var h=a(this.opts.emptyHtml).get(0);this.$editor.html(h);this.focus()}}this.sync()},formatBlocks:function(f){this.bufferSet();var e=this.getBlocks();this.selectionSave();a.each(e,a.proxy(function(g,h){if(h.tagName!=="LI"){var j=a(h).parent();if(f==="p"){if((h.tagName==="P"&&j.size()!=0&&j[0].tagName==="BLOCKQUOTE")||h.tagName==="BLOCKQUOTE"){this.formatQuote();return}else{if(this.opts.linebreaks){if(h&&h.tagName.search(/H[1-6]/)==0){a(h).replaceWith(h.innerHTML+"<br>")}else{return}}else{this.formatBlock(f,h)}}}else{this.formatBlock(f,h)}}},this));this.selectionRestore();this.sync()},formatBlock:function(j,e){if(e===false){e=this.getBlock()}if(e===false){if(this.opts.linebreaks===true){this.execCommand("formatblock",j)}return true}var f="";if(j!=="pre"){f=a(e).contents()}else{f=a(e).html();if(a.trim(f)===""){f='<span id="selection-marker-1"></span>'}}if(e.tagName==="PRE"){j="p"}if(this.opts.linebreaks===true&&j==="p"){a(e).replaceWith(a("<div>").append(f).html()+"<br>")}else{var h=this.getParent();var g=a("<"+j+">").append(f);a(e).replaceWith(g);if(h&&h.tagName=="TD"){a(g).wrapAll("<td>")}}},formatChangeTag:function(e,h,g){if(g!==false){this.selectionSave()}var f=a("<"+h+"/>");a(e).replaceWith(function(){return f.append(a(this).contents())});if(g!==false){this.selectionRestore()}return f},formatQuote:function(){this.bufferSet();if(this.opts.linebreaks===false){this.selectionSave();var g=this.getBlocks();var f=false;var l=g.length;if(g){var m="";var s="";var r=false;var q=true;a.each(g,function(w,x){if(x.tagName!=="P"){q=false}});a.each(g,a.proxy(function(x,y){if(y.tagName==="BLOCKQUOTE"){this.formatBlock("p",y,false)}else{if(y.tagName==="P"){f=a(y).parent();if(f[0].tagName=="BLOCKQUOTE"){var w=a(f).children("p").size();if(w==1){a(f).replaceWith(y)}else{if(w==l){r="blockquote";m+=this.outerHtml(y)}else{r="html";m+=this.outerHtml(y);if(x==0){a(y).addClass("redactor-replaced").empty();s=this.outerHtml(y)}else{a(y).remove()}}}}else{if(q===false||g.length==1){this.formatBlock("blockquote",y,false)}else{r="paragraphs";m+=this.outerHtml(y)}}}else{if(y.tagName!=="LI"){this.formatBlock("blockquote",y,false)}}}},this));if(r){if(r=="paragraphs"){a(g[0]).replaceWith("<blockquote>"+m+"</blockquote>");a(g).remove()}else{if(r=="blockquote"){a(f).replaceWith(m)}else{if(r=="html"){var n=this.$editor.html().replace(s,"</blockquote>"+m+"<blockquote>");this.$editor.html(n);this.$editor.find("blockquote").each(function(){if(a.trim(a(this).html())==""){a(this).remove()}})}}}}}this.selectionRestore()}else{var e=this.getBlock();if(e.tagName==="BLOCKQUOTE"){this.selectionSave();var n=a.trim(a(e).html());var t=a.trim(this.getSelectionHtml());n=n.replace(/<span(.*?)id="selection-marker(.*?)<\/span>/gi,"");if(n==t){a(e).replaceWith(a(e).html()+"<br>")}else{this.inlineFormat("tmp");var u=this.$editor.find("tmp");u.empty();var o=this.$editor.html().replace("<tmp></tmp>",'</blockquote><span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"+t+"<blockquote>");this.$editor.html(o);u.remove();this.$editor.find("blockquote").each(function(){if(a.trim(a(this).html())==""){a(this).remove()}})}this.selectionRestore();this.$editor.find("span#selection-marker-1").attr("id",false)}else{var v=this.selectionWrap("blockquote");var n=a(v).html();var j=["ul","ol","table","tr","tbody","thead","tfoot","dl"];a.each(j,function(w,x){n=n.replace(new RegExp("<"+x+"(.*?)>","gi"),"");n=n.replace(new RegExp("</"+x+">","gi"),"")});var h=this.opts.blockLevelElements;a.each(h,function(w,x){n=n.replace(new RegExp("<"+x+"(.*?)>","gi"),"");n=n.replace(new RegExp("</"+x+">","gi"),"<br>")});a(v).html(n);this.selectionElement(v);var p=a(v).next();if(p.size()!=0&&p[0].tagName==="BR"){p.remove()}}}this.sync()},blockRemoveAttr:function(e,g){var f=this.getBlocks();a(f).removeAttr(e);this.sync()},blockSetAttr:function(e,g){var f=this.getBlocks();a(f).attr(e,g);this.sync()},blockRemoveStyle:function(f){var e=this.getBlocks();a(e).css(f,"");this.removeEmptyAttr(e,"style");this.sync()},blockSetStyle:function(f,g){var e=this.getBlocks();a(e).css(f,g);this.sync()},blockRemoveClass:function(e){var f=this.getBlocks();a(f).removeClass(e);this.removeEmptyAttr(f,"class");this.sync()},blockSetClass:function(e){var f=this.getBlocks();a(f).addClass(e);this.sync()},inlineRemoveClass:function(e){this.selectionSave();this.inlineEachNodes(function(f){a(f).removeClass(e);this.removeEmptyAttr(f,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(e){var f=this.getCurrent();if(!a(f).hasClass(e)){this.inlineMethods("addClass",e)}},inlineRemoveStyle:function(e){this.selectionSave();this.inlineEachNodes(function(f){a(f).css(e,"");this.removeEmptyAttr(f,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(e,f){this.inlineMethods("css",e,f)},inlineRemoveAttr:function(e){this.selectionSave();var h=this.getRange(),f=this.getElement(),g=this.getNodes();if(h.collapsed||h.startContainer===h.endContainer&&f){g=a(f)}a(g).removeAttr(e);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(e,f){this.inlineMethods("attr",e,f)},inlineMethods:function(j,e,l){this.bufferSet();this.selectionSave();var h=this.getRange();var f=this.getElement();if((h.collapsed||h.startContainer===h.endContainer)&&f&&!this.nodeTestBlocks(f)){a(f)[j](e,l)}else{this.document.execCommand("fontSize",false,4);var g=this.$editor.find("font");a.each(g,a.proxy(function(m,n){this.inlineSetMethods(j,n,e,l)},this))}this.selectionRestore();this.sync()},inlineSetMethods:function(n,j,e,o){var g=a(j).parent(),f;var m=this.getSelectionText();var h=a(g).text();var l=m==h;if(l&&g&&g[0].tagName==="INLINE"&&g[0].attributes.length!=0){f=g;a(j).replaceWith(a(j).html())}else{f=a("<inline>").append(a(j).contents());a(j).replaceWith(f)}a(f)[n](e,o);return f},inlineEachNodes:function(e){var j=this.getRange(),g=this.getElement(),h=this.getNodes(),f;if(j.collapsed||j.startContainer===j.endContainer&&g){h=a(g);f=true}a.each(h,a.proxy(function(l,m){if(!f&&m.tagName!=="INLINE"){var p=this.getSelectionText();var n=a(m).parent().text();var o=p==n;if(o&&m.parentNode.tagName==="INLINE"&&!a(m.parentNode).hasClass("redactor_editor")){m=m.parentNode}else{return}}e.call(this,m)},this))},inlineUnwrapSpan:function(){var e=this.$editor.find("inline");a.each(e,a.proxy(function(g,h){var f=a(h);if(f.attr("class")===undefined&&f.attr("style")===undefined){f.contents().unwrap()}},this))},inlineFormat:function(g){this.selectionSave();this.document.execCommand("fontSize",false,4);var e=this.$editor.find("font");var f;a.each(e,function(j,l){var h=a("<"+g+"/>").append(a(l).contents());a(l).replaceWith(h);f=h});this.selectionRestore();this.sync()},inlineRemoveFormat:function(g){this.selectionSave();var h=g.toUpperCase();var e=this.getNodes();var f=a(this.getParent()).parent();a.each(e,function(j,l){if(l.tagName===h){this.inlineRemoveFormatReplace(l)}});if(f&&f[0].tagName===h){this.inlineRemoveFormatReplace(f)}this.selectionRestore();this.sync()},inlineRemoveFormatReplace:function(e){a(e).replaceWith(a(e).contents())},insertHtml:function(h,m){var g=this.getCurrent();var l=g.parentNode;this.focusWithSaveScroll();this.bufferSet();var e=a("<div>").append(a.parseHTML(h));h=e.html();h=this.cleanRemoveEmptyTags(h);e=a("<div>").append(a.parseHTML(h));var f=this.getBlock();if(e.contents().length==1){var j=e.contents()[0].tagName;if(j!="P"&&j==f.tagName||j=="PRE"){h=e.text();e=a("<div>").append(h)}}if(!this.opts.linebreaks&&e.contents().length==1&&e.contents()[0].nodeType==3&&(this.getRangeSelectedNodes().length>2||(!g||g.tagName=="BODY"&&!l||l.tagName=="HTML"))){h="<p>"+h+"</p>"}h=this.setSpansVerifiedHtml(h);if(e.contents().length>1&&f||e.contents().is("p, :header, ul, ol, li, div, table, td, blockquote, pre, address, section, header, footer, aside, article")){if(this.browser("msie")){if(!this.isIe11()){this.document.selection.createRange().pasteHTML(h)}else{this.execPasteFrag(h)}}else{this.document.execCommand("inserthtml",false,h)}}else{this.insertHtmlAdvanced(h,false)}if(this.selectall){this.window.setTimeout(a.proxy(function(){if(!this.opts.linebreaks){this.selectionEnd(this.$editor.contents().last())}else{this.focusEnd()}},this),1)}this.observeStart();this.setNonEditable();if(m!==false){this.sync()}},insertHtmlAdvanced:function(g,n){g=this.setSpansVerifiedHtml(g);var m=this.getSelection();if(m.getRangeAt&&m.rangeCount){var l=m.getRangeAt(0);l.deleteContents();var e=this.document.createElement("div");e.innerHTML=g;var f=this.document.createDocumentFragment(),j,h;while((j=e.firstChild)){h=f.appendChild(j)}l.insertNode(f);if(h){l=l.cloneRange();l.setStartAfter(h);l.collapse(true);m.removeAllRanges();m.addRange(l)}}if(n!==false){this.sync()}},insertBeforeCursor:function(e){e=this.setSpansVerifiedHtml(e);var f=a(e);var j=document.createElement("span");j.innerHTML="\u200B";var g=this.getRange();g.insertNode(j);g.insertNode(f[0]);g.collapse(false);var h=this.getSelection();h.removeAllRanges();h.addRange(g);this.sync()},insertText:function(f){var e=a(a.parseHTML(f));if(e.length){f=e.text()}this.focusWithSaveScroll();if(this.browser("msie")&&!this.isIe11()){this.document.selection.createRange().pasteHTML(f)}else{this.document.execCommand("inserthtml",false,f)}this.sync()},insertNode:function(f){f=f[0]||f;if(f.tagName=="SPAN"){var j="inline";var g=f.outerHTML;var h=new RegExp("<"+f.tagName,"i");var e=g.replace(h,"<"+j);h=new RegExp("</"+f.tagName,"i");e=e.replace(h,"</"+j);f=a(e)[0]}var l=this.getSelection();if(l.getRangeAt&&l.rangeCount){range=l.getRangeAt(0);range.deleteContents();range.insertNode(f);range.setEndAfter(f);range.setStartAfter(f);l.removeAllRanges();l.addRange(range)}},insertNodeToCaretPositionFromPoint:function(f,h){var l;var m=f.clientX,n=f.clientY;if(this.document.caretPositionFromPoint){var j=this.document.caretPositionFromPoint(m,n);l=this.getRange();l.setStart(j.offsetNode,j.offset);l.collapse(true);l.insertNode(h)}else{if(this.document.caretRangeFromPoint){l=this.document.caretRangeFromPoint(m,n);l.insertNode(h)}else{if(typeof document.body.createTextRange!="undefined"){l=this.document.body.createTextRange();l.moveToPoint(m,n);var g=l.duplicate();g.moveToPoint(m,n);l.setEndPoint("EndToEnd",g);l.select()}}}},insertAfterLastElement:function(f,g){if(typeof(g)!="undefined"){f=g}if(this.isEndOfElement()){if(this.opts.linebreaks){var e=a("<div>").append(a.trim(this.$editor.html())).contents();if(this.outerHtml(e.last()[0])!=this.outerHtml(f)){return false}}else{if(this.$editor.contents().last()[0]!==f){return false}}this.insertingAfterLastElement(f)}},insertingAfterLastElement:function(e){this.bufferSet();if(this.opts.linebreaks===false){var f=a(this.opts.emptyHtml);a(e).after(f);this.selectionStart(f)}else{var f=a('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0];a(e).after(f);a(f).after(this.opts.invisibleSpace);this.selectionRestore();this.$editor.find("span#selection-marker-1").removeAttr("id")}},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(e){var f=a("<br>"+this.opts.invisibleSpace);a(e).replaceWith(f);this.selectionStart(f)},pasteClean:function(f){f=this.callback("pasteBefore",false,f);if(this.browser("msie")){var l=a.trim(f);if(l.search(/^<a(.*?)>(.*?)<\/a>$/i)==0){f=f.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2")}}if(this.opts.pastePlainText){var l=this.document.createElement("div");f=f.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");l.innerHTML=f;f=l.textContent||l.innerText;f=a.trim(f);f=f.replace("\n","<br>");f=this.cleanParagraphy(f);this.pasteInsert(f);return false}var j=false;if(this.currentOrParentIs("TD")){j=true;var e=this.opts.blockLevelElements;e.push("tr");e.push("table");a.each(e,function(m,n){f=f.replace(new RegExp("<"+n+"(.*?)>","gi"),"");f=f.replace(new RegExp("</"+n+">","gi"),"<br>")})}if(this.currentOrParentIs("PRE")){f=this.pastePre(f);this.pasteInsert(f);return true}f=f.replace(/<img(.*?)v:shapes=(.*?)>/gi,"");f=f.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><li$2</li>");f=f.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi,"<li$2</li>");f=f.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<li$2</li></ul>");f=f.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi,"<ul><li$2</li></ul>");f=f.replace(/·/g,"");f=f.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"");f=f.replace(/(&nbsp;){2,}/gi,"&nbsp;");f=f.replace(/&nbsp;/gi," ");f=f.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");f=f.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");f=this.cleanStripTags(f);f=f.replace(/<td>\u200b*<\/td>/gi,"[td]");f=f.replace(/<td>&nbsp;<\/td>/gi,"[td]");f=f.replace(/<td><br><\/td>/gi,"[td]");f=f.replace(/<td(.*?)colspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td colspan="$2"]$4[/td]');f=f.replace(/<td(.*?)rowspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td rowspan="$2"]$4[/td]');f=f.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');f=f.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");f=f.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");f=f.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");f=f.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");f=f.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");f=f.replace(/<param(.*?)>/gi,"[param$1]");f=f.replace(/<img(.*?)>/gi,"[img$1]");f=f.replace(/ class="(.*?)"/gi,"");f=f.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");f=f.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");f=f.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");f=f.replace(/\[td colspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td colspan="$1">$2</td>');f=f.replace(/\[td rowspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td rowspan="$1">$2</td>');f=f.replace(/\[td\]/gi,"<td>&nbsp;</td>");f=f.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');f=f.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");f=f.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");f=f.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");f=f.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");f=f.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");f=f.replace(/\[param(.*?)\]/gi,"<param$1>");f=f.replace(/\[img(.*?)\]/gi,"<img$1>");if(this.opts.convertDivs){f=f.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>");f=f.replace(/<\/div><p>/gi,"<p>");f=f.replace(/<\/p><\/div>/gi,"</p>");f=f.replace(/<p><\/p>/gi,"<br />")}else{f=f.replace(/<div><\/div>/gi,"<br />")}if(this.currentOrParentIs("LI")){f=f.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br>")}else{if(j===false){f=this.cleanParagraphy(f)}}f=f.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");f=f.replace(/<img>/gi,"");f=f.replace(/<[^\/>][^>][^img|param|source|td][^<]*>(\s*|\t*|\n*| |<br>)<\/[^>]+>/gi,"");f=f.replace(/\n{3,}/gi,"\n");f=f.replace(/<p><p>/gi,"<p>");f=f.replace(/<\/p><\/p>/gi,"</p>");f=f.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");f=f.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");if(this.opts.linebreaks===true){f=f.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}f=f.replace(/<[^\/>][^>][^img|param|source|td][^<]*>(\s*|\t*|\n*| |<br>)<\/[^>]+>/gi,"");f=f.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,"");f=f.replace(/<td(.*?)>(\s*|\t*|\n*)<p>([\w\W]*?)<\/p>(\s*|\t*|\n*)<\/td>/gi,"<td$1>$3</td>");if(this.opts.convertDivs){f=f.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2");f=f.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2")}this.pasteClipboardMozilla=false;if(this.browser("mozilla")){if(this.opts.clipboardUpload){var h=f.match(/<img src="data:image(.*?)"(.*?)>/gi);if(h!==null){this.pasteClipboardMozilla=h;for(k in h){var g=h[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');f=f.replace(h[k],g)}}}while(/<br>$/gi.test(f)){f=f.replace(/<br>$/gi,"")}}f=f.replace(/<p>•([\w\W]*?)<\/p>/gi,"<li>$1</li>");while(/<font>([\w\W]*?)<\/font>/gi.test(f)){f=f.replace(/<font>([\w\W]*?)<\/font>/gi,"$1")}if(j===false){f=f.replace(/<td(.*?)>([\w\W]*?)<p(.*?)>([\w\W]*?)<\/td>/gi,"<td$1>$2$4</td>");f=f.replace(/<td(.*?)>([\w\W]*?)<\/p>([\w\W]*?)<\/td>/gi,"<td$1>$2$3</td>");f=f.replace(/<td(.*?)>([\w\W]*?)<p(.*?)>([\w\W]*?)<\/td>/gi,"<td$1>$2$4</td>");f=f.replace(/<td(.*?)>([\w\W]*?)<\/p>([\w\W]*?)<\/td>/gi,"<td$1>$2$3</td>")}f=f.replace(/\n/g," ");f=f.replace(/<p>\n?<li>/gi,"<li>");this.pasteInsert(f)},pastePre:function(e){e=e.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var f=this.document.createElement("div");f.innerHTML=e;return this.cleanEncodeEntities(f.textContent||f.innerText)},pasteInsert:function(e){e=this.callback("pasteAfter",false,e);if(this.selectall){this.$editor.html(e);this.selectionRemove();this.focusEnd();this.sync()}else{this.insertHtml(e)}this.selectall=false;setTimeout(a.proxy(function(){this.rtePaste=false;if(this.browser("mozilla")){this.$editor.find("p:empty").remove()}if(this.pasteClipboardMozilla!==false){this.pasteClipboardUploadMozilla()}},this),100);if(this.opts.autoresize&&this.fullscreen!==true){a(this.document.body).scrollTop(this.saveScroll)}else{this.$editor.scrollTop(this.saveScroll)}},pasteClipboardAppendFields:function(e){if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){a.each(this.opts.uploadFields,a.proxy(function(f,g){if(g!=null&&g.toString().indexOf("#")===0){g=a(g).val()}e[f]=g},this))}return e},pasteClipboardUploadMozilla:function(){var e=this.$editor.find("img[data-mozilla-paste-image]");a.each(e,a.proxy(function(h,l){var f=a(l);var g=l.src.split(",");var j={contentType:g[0].split(";")[0].split(":")[1],data:g[1]};j=this.pasteClipboardAppendFields(j);a.post(this.opts.clipboardUploadUrl,j,a.proxy(function(m){var n=(typeof m==="string"?a.parseJSON(m):m);f.attr("src",n.filelink);f.removeAttr("data-mozilla-paste-image");this.sync();this.callback("imageUpload",f,n)},this))},this))},pasteClipboardUpload:function(g){var j=g.target.result;var f=j.split(",");var h={contentType:f[0].split(";")[0].split(":")[1],data:f[1]};if(this.opts.clipboardUpload){h=this.pasteClipboardAppendFields(h);a.post(this.opts.clipboardUploadUrl,h,a.proxy(function(e){var n=(typeof e==="string"?a.parseJSON(e):e);var l='<img src="'+n.filelink+'" id="clipboard-image-marker" />';this.execCommand("inserthtml",l,false);var m=a(this.$editor.find("img#clipboard-image-marker"));if(m.length){m.removeAttr("id")}else{m=false}this.sync();if(m){this.callback("imageUpload",m,n)}},this))}else{this.insertHtml('<img src="'+j+'" />')}},bufferSet:function(e,f){if(e!==undefined||e===false){this.opts.buffer.push(e)}else{if(f!==false){this.selectionSave()}this.opts.buffer.push(this.$editor.html());this.selectionRemoveMarkers("buffer")}},bufferUndo:function(){if(this.opts.buffer.length===0){this.focusWithSaveScroll();return}this.selectionSave();this.opts.rebuffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.buffer.pop());this.selectionRestore();setTimeout(a.proxy(this.observeStart,this),100)},bufferRedo:function(){if(this.opts.rebuffer.length===0){this.focusWithSaveScroll();return false}this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.rebuffer.pop());this.selectionRestore(true);setTimeout(a.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();if(this.opts.observeLinks){this.observeLinks()}},observeLinks:function(){this.$editor.find("a").on("click",a.proxy(this.linkObserver,this));this.$editor.on("click.redactor",a.proxy(function(f){this.linkObserverTooltipClose(f)},this));a(document).on("click.redactor",a.proxy(function(f){this.linkObserverTooltipClose(f)},this))},observeImages:function(){if(this.opts.observeImages===false){return false}this.$editor.find("img").each(a.proxy(function(f,e){if(this.browser("msie")){a(e).attr("unselectable","on")}this.imageResize(e)},this))},linkObserver:function(l){var f=a(l.target);if(f.size()==0||f[0].tagName!=="A"){return}var n=f.offset();if(this.opts.iframe){var o=this.$frame.offset();n.top=o.top+(n.top-a(this.document).scrollTop());n.left+=o.left}var p=a('<span class="redactor-link-tooltip"></span>');var m=f.attr("href");if(m.length>24){m=m.substring(0,24)+"..."}var h=a('<a href="'+f.attr("href")+'" target="_blank">'+m+"</a>").on("click",a.proxy(function(q){this.linkObserverTooltipClose(false)},this));var g=a('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",a.proxy(function(q){q.preventDefault();this.linkShow();this.linkObserverTooltipClose(false)},this));var j=a('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",a.proxy(function(q){q.preventDefault();this.execCommand("unlink");this.linkObserverTooltipClose(false)},this));p.append(h);p.append(" | ");p.append(g);p.append(" | ");p.append(j);p.css({top:(n.top+20)+"px",left:n.left+"px"});a(".redactor-link-tooltip").remove();a("body").append(p)},linkObserverTooltipClose:function(f){if(f!==false&&f.target.tagName=="A"){return false}a(".redactor-link-tooltip").remove()},getSelection:function(){if(!this.opts.rangy){return this.document.getSelection()}else{if(!this.opts.iframe){return rangy.getSelection()}else{return rangy.getSelection(this.$frame[0])}}},getRange:function(){if(!this.opts.rangy){if(this.document.getSelection){var e=this.getSelection();if(e.getRangeAt&&e.rangeCount){return e.getRangeAt(0)}}return this.document.createRange()}else{if(!this.opts.iframe){return rangy.createRange()}else{return rangy.createRange(this.iframeDoc())}}},selectionElement:function(e){this.setCaret(e)},selectionStart:function(e){this.selectionSet(e[0]||e,0,null,0)},selectionEnd:function(e){this.selectionSet(e[0]||e,1,null,1)},selectionSet:function(j,l,g,h){if(g==null){g=j}if(h==null){h=l}var o=this.getSelection();if(!o){return}if(j.tagName=="P"&&j.innerHTML==""){j.innerHTML=this.opts.invisibleSpace}if(j.tagName=="BR"&&this.opts.linebreaks===false){var m=a(this.opts.emptyHtml)[0];a(j).replaceWith(m);j=m;g=j}var n=this.getRange();n.setStart(j,l);n.setEnd(g,h);try{o.removeAllRanges()}catch(f){}o.addRange(n)},selectionWrap:function(h){h=h.toLowerCase();var e=this.getBlock();if(e){var j=this.formatChangeTag(e,h);this.sync();return j}var g=this.getSelection();var f=g.getRangeAt(0);var j=document.createElement(h);j.appendChild(f.extractContents());f.insertNode(j);this.selectionElement(j);return j},selectionAll:function(){var e=this.getRange();e.selectNodeContents(this.$editor[0]);var f=this.getSelection();f.removeAllRanges();f.addRange(e)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(f){var e=0;var h=this.getRange();var g=h.cloneRange();g.selectNodeContents(f);g.setEnd(h.endContainer,h.endOffset);e=a.trim(g.toString()).length;return e},getCaretOffsetRange:function(){return new b(this.getSelection().getRangeAt(0))},setCaret:function(f,o,g){if(typeof g==="undefined"){g=o}f=f[0]||f;var m=this.getRange();m.selectNodeContents(f);var q=this.getTextNodesIn(f);var j=false;var e=0,h;if(q.length==1&&o){m.setStart(q[0],o);m.setEnd(q[0],g)}else{for(var l=0,p;p=q[l++];){h=e+p.length;if(!j&&o>=e&&(o<h||(o==h&&l<q.length))){m.setStart(p,o-e);j=true}if(j&&g<=h){m.setEnd(p,g-e);break}e=h}}var n=this.getSelection();n.removeAllRanges();n.addRange(m)},getTextNodesIn:function(h){var j=[];if(h.nodeType==3){j.push(h)}else{var e=h.childNodes;for(var f=0,g=e.length;f<g;++f){j.push.apply(j,this.getTextNodesIn(e[f]))}}return j},getCurrent:function(){var e=false;var f=this.getSelection();if(f&&f.rangeCount>0){e=f.getRangeAt(0).startContainer}return this.isParentRedactor(e)},getParent:function(e){e=e||this.getCurrent();if(e){return this.isParentRedactor(a(e).parent()[0])}else{return false}},getBlock:function(e){if(typeof e==="undefined"){e=this.getCurrent()}while(e){if(this.nodeTestBlocks(e)){if(a(e).hasClass("redactor_editor")){return false}return e}e=e.parentNode}return false},getBlocks:function(f){var e=[];if(typeof f=="undefined"){var g=this.getRange();if(g&&g.collapsed===true){return[this.getBlock()]}var f=this.getNodes(g)}a.each(f,a.proxy(function(h,j){if(this.opts.iframe===false&&a(j).parents("div.redactor_editor").size()==0){return false}if(this.nodeTestBlocks(j)){e.push(j)}},this));if(e.length===0){e=[this.getBlock()]}return e},nodeTestBlocks:function(e){return e.nodeType==1&&this.rTestBlock.test(e.nodeName)},tagTestBlock:function(e){return this.rTestBlock.test(e)},getNodes:function(j,m){if(typeof j=="undefined"||j==false){var j=this.getRange()}if(j&&j.collapsed===true){if(typeof m==="undefined"&&this.tagTestBlock(m)){var e=this.getBlock();if(e.tagName==m){return[e]}else{return[]}}else{return[this.getCurrent()]}}var h=[],f=[];var l=this.document.getSelection();if(!l.isCollapsed){h=this.getRangeSelectedNodes(l.getRangeAt(0))}a.each(h,a.proxy(function(n,o){if(this.opts.iframe===false&&a(o).parents("div.redactor_editor").size()==0){return false}if(typeof m==="undefined"){if(a.trim(o.textContent)!=""){f.push(o)}}else{if(o.tagName==m){f.push(o)}}},this));if(f.length==0){if(typeof m==="undefined"&&this.tagTestBlock(m)){var e=this.getBlock();if(e.tagName==m){return f.push(e)}else{return[]}}else{f.push(this.getCurrent())}}var g=f[f.length-1];if(this.nodeTestBlocks(g)){f=f.slice(0,-1)}return f},getElement:function(e){if(!e){e=this.getCurrent()}while(e){if(e.nodeType==1){if(a(e).hasClass("redactor_editor")){return false}return e}e=e.parentNode}return false},getRangeSelectedNodes:function(g){g=g||this.getRange();var f=g.startContainer;var e=g.endContainer;if(f==e){return[f]}var h=[];while(f&&f!=e){h.push(f=this.nextNode(f))}f=g.startContainer;while(f&&f!=g.commonAncestorContainer){h.unshift(f);f=f.parentNode}return h},nextNode:function(e){if(e.hasChildNodes()){return e.firstChild}else{while(e&&!e.nextSibling){e=e.parentNode}if(!e){return null}return e.nextSibling}},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var f="";var j=this.getSelection();if(j.rangeCount){var e=this.document.createElement("div");var h=j.rangeCount;for(var g=0;g<h;++g){e.appendChild(j.getRangeAt(g).cloneContents())}f=e.innerHTML}return this.syncClean(f)},selectionSave:function(){if(!this.isFocused()){this.focusWithSaveScroll()}if(!this.opts.rangy){this.selectionCreateMarker(this.getRange())}else{this.savedSel=rangy.saveSelection()}},selectionCreateMarker:function(g,h){if(!g){return}var e=a('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];var f=a('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];if(g.collapsed===true){this.selectionSetMarker(g,e,true)}else{this.selectionSetMarker(g,e,true);this.selectionSetMarker(g,f,false)}this.savedSel=this.$editor.html();this.selectionRestore(false,false)},selectionSetMarker:function(g,f,h){var e=g.cloneRange();e.collapse(h);e.insertNode(f);e.detach()},selectionRestore:function(h,g){if(!this.opts.rangy){if(h===true&&this.savedSel){this.$editor.html(this.savedSel)}var e=this.$editor.find("span#selection-marker-1");var f=this.$editor.find("span#selection-marker-2");if(this.browser("mozilla")){this.$editor.focus()}else{if(!this.isFocused()){this.focusWithSaveScroll()}}if(e.length!=0&&f.length!=0){this.selectionSet(e[0],0,f[0],0)}else{if(e.length!=0){this.selectionSet(e[0],0,null,0)}}if(g!==false){this.selectionRemoveMarkers();this.savedSel=false}}else{rangy.restoreSelection(this.savedSel)}},selectionRemoveMarkers:function(e){if(!this.opts.rangy){a.each(this.$editor.find("span.redactor-selection-marker"),function(){var f=a.trim(a(this).html().replace(/[^\u0000-\u1C7F]/g,""));if(f==""){a(this).remove()}else{a(this).removeAttr("class").removeAttr("id")}})}else{rangy.removeMarkers(this.savedSel)}},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,a.proxy(function(){a("#redactor_insert_table_btn").click(a.proxy(this.tableInsert,this));setTimeout(function(){a("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){this.bufferSet(false,false);var o=a("#redactor_table_rows").val(),j=a("#redactor_table_columns").val(),h=a("<div></div>"),q=Math.floor(Math.random()*99999),g=a('<table id="table'+q+'"><tbody></tbody></table>'),n,f,r,e;for(n=0;n<o;n++){f=a("<tr></tr>");for(r=0;r<j;r++){e=a("<td>"+this.opts.invisibleSpace+"</td>");if(n===0&&r===0){e.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}a(f).append(e)}g.append(f)}h.append(g);var m=h.html();this.modalClose();this.selectionRestore();var l=this.getBlock()||this.getCurrent();if(l&&l.tagName!="BODY"){if(l.tagName=="LI"){var l=a(l).closest("ul, ol")}a(l).after(m)}else{this.insertHtmlAdvanced(m,false)}this.selectionRestore();var p=this.$editor.find("#table"+q);this.buttonActiveObserver();p.find("span#selection-marker-1, inline#selection-marker-1").remove();p.removeAttr("id");this.sync()},tableDeleteTable:function(){var e=a(this.getParent()).closest("table");if(!this.isParentRedactor(e)){return false}if(e.size()==0){return false}this.bufferSet();e.remove();this.sync()},tableDeleteRow:function(){var j=this.getParent();var h=a(j).closest("table");if(!this.isParentRedactor(h)){return false}if(h.size()==0){return false}this.bufferSet();var e=a(j).closest("tr");var g=e.prev().length?e.prev():e.next();if(g.length){var f=g.children("td").first();if(f.length){f.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}}e.remove();this.selectionRestore();this.sync()},tableDeleteColumn:function(){var h=this.getParent();var f=a(h).closest("table");if(!this.isParentRedactor(f)){return false}if(f.size()==0){return false}this.bufferSet();var e=a(h).closest("td");if(!(e.is("td"))){e=e.closest("td")}var g=e.get(0).cellIndex;f.find("tr").each(a.proxy(function(m,j){var l=g-1<0?g+1:g-1;if(m===0){a(j).find("td").eq(l).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}a(j).find("td").eq(g).remove()},this));this.selectionRestore();this.sync()},tableAddHead:function(){var e=a(this.getParent()).closest("table");if(!this.isParentRedactor(e)){return false}if(e.size()==0){return false}this.bufferSet();if(e.find("thead").size()!==0){this.tableDeleteHead()}else{var f=e.find("tr").first().clone();f.find("td").html(this.opts.invisibleSpace);$thead=a("<thead></thead>");$thead.append(f);e.prepend($thead);this.sync()}},tableDeleteHead:function(){var e=a(this.getParent()).closest("table");if(!this.isParentRedactor(e)){return false}var f=e.find("thead");if(f.size()==0){return false}this.bufferSet();f.remove();this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(h){var f=a(this.getParent()).closest("table");if(!this.isParentRedactor(f)){return false}if(f.size()==0){return false}this.bufferSet();var e=a(this.getParent()).closest("tr");var g=e.clone();g.find("td").html(this.opts.invisibleSpace);if(h==="after"){e.after(g)}else{e.before(g)}this.sync()},tableAddColumn:function(m){var l=this.getParent();var g=a(l).closest("table");if(!this.isParentRedactor(g)){return false}if(g.size()==0){return false}this.bufferSet();var j=0;var h=this.getCurrent();var f=a(h).closest("tr");var e=a(h).closest("td");f.find("td").each(a.proxy(function(o,n){if(a(n)[0]===e[0]){j=o}},this));g.find("tr").each(a.proxy(function(p,o){var n=a(o).find("td").eq(j);var q=n.clone();q.html(this.opts.invisibleSpace);m==="after"?n.after(q):n.before(q)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,a.proxy(function(){a("#redactor_insert_video_btn").click(a.proxy(this.videoInsert,this));setTimeout(function(){a("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var f=a("#redactor_insert_video_area").val();f=this.cleanStripTags(f);this.selectionRestore();var e=this.getBlock()||this.getCurrent();if(e){a(e).after(f)}else{this.insertHtmlAdvanced(f,false)}this.sync();this.modalClose()},linkShow:function(){this.selectionSave();var e=a.proxy(function(){this.insert_link_node=false;var j=this.getSelection();var q="",n="",m="";var f=this.getParent();var g=a(f).parent().get(0);if(g&&g.tagName==="A"){f=g}if(f&&f.tagName==="A"){q=f.href;n=a(f).text();m=f.target;this.insert_link_node=f}else{n=j.toString()}a(".redactor_link_text").val(n);var o=self.location.href.replace(/\/$/i,"");var p=q.replace(o,"");if(this.opts.linkProtocol===false){var h=new RegExp("^(http|ftp|https)://"+self.location.host,"i");p=p.replace(h,"")}var l=a("#redactor_tabs").find("a");if(this.opts.linkEmail===false){l.eq(1).remove()}if(this.opts.linkAnchor===false){l.eq(2).remove()}if(this.opts.linkEmail===false&&this.opts.linkAnchor===false){a("#redactor_tabs").remove();a("#redactor_link_url").val(p)}else{if(q.search("mailto:")===0){this.modalSetTab.call(this,2);a("#redactor_tab_selected").val(2);a("#redactor_link_mailto").val(q.replace("mailto:",""))}else{if(p.search(/^#/gi)===0){this.modalSetTab.call(this,3);a("#redactor_tab_selected").val(3);a("#redactor_link_anchor").val(p.replace(/^#/gi,""))}else{a("#redactor_link_url").val(p)}}}if(m==="_blank"){a("#redactor_link_blank").prop("checked",true)}this.linkInsertPressed=false;a("#redactor_insert_link_btn").click(a.proxy(this.linkProcess,this));setTimeout(function(){a("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,e)},linkProcess:function(){if(this.linkInsertPressed){return}this.linkInsertPressed=true;var j=a("#redactor_tab_selected").val();var e="",n="",l="",m="";if(j==="1"){e=a("#redactor_link_url").val();n=a("#redactor_link_url_text").val();if(a("#redactor_link_blank").prop("checked")){l=' target="_blank"';m="_blank"}var f="((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}";var g=new RegExp("^(http|ftp|https)://"+f,"i");var h=new RegExp("^"+f,"i");if(e.search(g)==-1&&e.search(h)==0&&this.opts.linkProtocol){e=this.opts.linkProtocol+e}}else{if(j==="2"){e="mailto:"+a("#redactor_link_mailto").val();n=a("#redactor_link_mailto_text").val()}else{if(j==="3"){e="#"+a("#redactor_link_anchor").val();n=a("#redactor_link_anchor_text").val()}}}n=n.replace(/<|>/g,"");this.linkInsert('<a href="'+e+'"'+l+">"+n+"</a>",a.trim(n),e,m)},linkInsert:function(f,j,g,h){this.selectionRestore();if(j!==""){if(this.insert_link_node){this.bufferSet();a(this.insert_link_node).text(j).attr("href",g);if(h!==""){a(this.insert_link_node).attr("target",h)}else{a(this.insert_link_node).removeAttr("target")}this.sync()}else{var e=a(f).addClass("redactor-added-link");this.exec("inserthtml",this.outerHtml(e),false);this.$editor.find("a.redactor-added-link").removeAttr("style").removeClass("redactor-added-link").each(function(){if(this.className==""){a(this).removeAttr("class")}});this.sync()}}setTimeout(a.proxy(function(){if(this.opts.observeLinks){this.observeLinks()}},this),5);this.modalClose()},fileShow:function(){this.selectionSave();var e=a.proxy(function(){var f=this.getSelection();var g="";if(this.oldIE()){g=f.text}else{g=f.toString()}a("#redactor_filename").val(g);if(!this.isMobile()&&!this.isIPad()){this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:a.proxy(this.fileCallback,this),error:a.proxy(function(j,h){this.callback("fileUploadError",h)},this),uploadParam:this.opts.fileUploadParam})}this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload,success:a.proxy(this.fileCallback,this),error:a.proxy(function(j,h){this.callback("fileUploadError",h)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,e)},fileCallback:function(e){this.selectionRestore();if(e!==false){var h=a("#redactor_filename").val();if(h===""){h=e.filename}var f='<a href="'+e.filelink+'" id="filelink-marker">'+h+"</a>";if(this.browser("webkit")&&!!this.window.chrome){f=f+"&nbsp;"}this.execCommand("inserthtml",f,false);var g=a(this.$editor.find("a#filelink-marker"));if(g.size()!=0){g.removeAttr("id")}else{g=false}this.sync();this.callback("fileUpload",g,e)}this.modalClose()},imageShow:function(){this.selectionSave();var e=a.proxy(function(){if(this.opts.imageGetJson){a.getJSON(this.opts.imageGetJson,a.proxy(function(g){var j={},f=0;a.each(g,a.proxy(function(n,o){if(typeof o.folder!=="undefined"){f++;j[o.folder]=f}},this));var h=false;a.each(g,a.proxy(function(p,r){var q="";if(typeof r.title!=="undefined"){q=r.title}var n=0;if(!a.isEmptyObject(j)&&typeof r.folder!=="undefined"){n=j[r.folder];if(h===false){h=".redactorfolder"+n}}var o=a('<img src="'+r.thumb+'" class="redactorfolder redactorfolder'+n+'" rel="'+r.image+'" title="'+q+'" />');a("#redactor_image_box").append(o);a(o).click(a.proxy(this.imageThumbClick,this))},this));if(!a.isEmptyObject(j)){a(".redactorfolder").hide();a(h).show();var l=function(n){a(".redactorfolder").hide();a(".redactorfolder"+a(n.target).val()).show()};var m=a('<select id="redactor_image_box_select">');a.each(j,function(n,o){m.append(a('<option value="'+o+'">'+n+"</option>"))});a("#redactor_image_box").before(m);m.change(l)}},this))}else{a("#redactor-modal-tab-2").remove()}if(this.opts.imageUpload||this.opts.s3){if(!this.isMobile()&&!this.isIPad()&&this.opts.s3===false){if(a("#redactor_file").length){this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:a.proxy(this.imageCallback,this),error:a.proxy(function(g,f){this.callback("imageUploadError",f)},this),uploadParam:this.opts.imageUploadParam})}}if(this.opts.s3===false){this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload,success:a.proxy(this.imageCallback,this),error:a.proxy(function(g,f){this.callback("imageUploadError",f)},this)})}else{a("#redactor_file").on("change.redactor",a.proxy(this.s3handleFileSelect,this))}}else{a(".redactor_tab").hide();if(!this.opts.imageGetJson){a("#redactor_tabs").remove();a("#redactor_tab3").show()}else{a("#redactor-modal-tab-1").remove();a("#redactor-modal-tab-2").addClass("redactor_tabs_act");a("#redactor_tab2").show()}}if(!this.opts.imageTabLink&&(this.opts.imageUpload||this.opts.imageGetJson)){a("#redactor-tab-control-3").hide()}a("#redactor_upload_btn").click(a.proxy(this.imageCallbackLink,this));if(!this.opts.imageUpload&&!this.opts.imageGetJson){setTimeout(function(){a("#redactor_file_link").focus()},200)}},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,e)},imageEdit:function(g){var e=g;var h=e.parent().parent();var f=a.proxy(function(){a("#redactor_file_alt").val(e.attr("alt"));a("#redactor_image_edit_src").attr("href",e.attr("src"));if(e.css("display")=="block"&&e.css("float")=="none"){a("#redactor_form_image_align").val("center")}else{a("#redactor_form_image_align").val(e.css("float"))}if(a(h).get(0).tagName==="A"){a("#redactor_file_link").val(a(h).attr("href"));if(a(h).attr("target")=="_blank"){a("#redactor_link_blank").prop("checked",true)}}a("#redactor_image_delete_btn").click(a.proxy(function(){this.imageRemove(e)},this));a("#redactorSaveBtn").click(a.proxy(function(){this.imageSave(e)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,f)},imageRemove:function(e){var h=a(e).parent().parent();var f=a(e).parent();var g=false;if(h.length&&h[0].tagName==="A"){g=true;a(h).remove()}else{if(f.length&&f[0].tagName==="A"){g=true;a(f).remove()}else{a(e).remove()}}if(f.length&&f[0].tagName==="P"){this.focusWithSaveScroll();if(g===false){this.selectionStart(f)}}this.callback("imageDelete",e);this.modalClose();this.sync()},imageSave:function(g){var e=a(g);var m=e.parent();e.attr("alt",a("#redactor_file_alt").val());var h=a("#redactor_form_image_align").val();var l="";this.imageResizeHide(false);if(h==="left"){l="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";e.css({"float":"left",margin:l})}else{if(h==="right"){l="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+"";e.css({"float":"right",margin:l})}else{if(h==="center"){e.css({"float":"",display:"block",margin:"auto"})}else{e.css({"float":"",display:"",margin:""})}}}var j=a.trim(a("#redactor_file_link").val());if(j!==""){var n=false;if(a("#redactor_link_blank").prop("checked")){n=true}if(m.get(0).tagName!=="A"){var f=a('<a href="'+j+'">'+this.outerHtml(g)+"</a>");if(n){f.attr("target","_blank")}e.replaceWith(f)}else{m.attr("href",j);if(n){m.attr("target","_blank")}else{m.removeAttr("target")}}}else{if(m.get(0).tagName==="A"){m.replaceWith(this.outerHtml(g))}}this.modalClose();this.observeImages();this.sync()},imageResizeHide:function(f){if(f!==false&&a(f.target).parent().size()!=0&&a(f.target).parent()[0].id==="redactor-image-box"){return false}var g=this.$editor.find("#redactor-image-box");if(g.size()==0){return false}this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove();g.find("img").css({marginTop:g[0].style.marginTop,marginBottom:g[0].style.marginBottom,marginLeft:g[0].style.marginLeft,marginRight:g[0].style.marginRight});g.css("margin","");g.find("img").css("opacity","");g.replaceWith(function(){return a(this).contents()});a(document).off("click.redactor-image-resize-hide");this.$editor.off("click.redactor-image-resize-hide");this.$editor.off("keydown.redactor-image-delete");this.sync()},imageResize:function(f){var e=a(f);e.on("mousedown",a.proxy(function(){this.imageResizeHide(false)},this));e.on("dragstart",a.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",a.proxy(function(){setTimeout(a.proxy(function(){this.observeImages();this.$editor.off("drop.redactor-image-inside-drop");this.sync()},this),1)},this))},this));e.on("click",a.proxy(function(h){if(this.$editor.find("#redactor-image-box").size()!=0){return false}var g=false,p,q,o=e.width()/e.height(),n=20,m=10;var j=this.imageResizeControls(e);var l=false;j.on("mousedown",function(r){l=true;r.preventDefault();o=e.width()/e.height();p=Math.round(r.pageX-e.eq(0).offset().left);q=Math.round(r.pageY-e.eq(0).offset().top)});a(this.document.body).on("mousemove",a.proxy(function(s){if(l){var t=Math.round(s.pageX-e.eq(0).offset().left)-p;var u=Math.round(s.pageY-e.eq(0).offset().top)-q;var r=e.height();var v=parseInt(r,10)+u;var w=Math.round(v*o);if(w>n){e.width(w);if(w<100){this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"})}else{this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"})}}p=Math.round(s.pageX-e.eq(0).offset().left);q=Math.round(s.pageY-e.eq(0).offset().top);this.sync()}},this)).on("mouseup",function(){l=false});this.$editor.on("keydown.redactor-image-delete",a.proxy(function(r){var s=r.which;if(this.keyCode.BACKSPACE==s||this.keyCode.DELETE==s){this.bufferSet(false,false);this.imageResizeHide(false);this.imageRemove(e)}},this));a(document).on("click.redactor-image-resize-hide",a.proxy(this.imageResizeHide,this));this.$editor.on("click.redactor-image-resize-hide",a.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(e){var f=a('<span id="redactor-image-box" data-redactor="verified">');f.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":e.css("float")});f.attr("contenteditable",false);if(e[0].style.margin!="auto"){f.css({marginTop:e[0].style.marginTop,marginBottom:e[0].style.marginBottom,marginLeft:e[0].style.marginLeft,marginRight:e[0].style.marginRight});e.css("margin","")}else{f.css({display:"block",margin:"auto"})}e.css("opacity",0.5).after(f);this.imageEditter=a('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>");this.imageEditter.css({position:"absolute",zIndex:5,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"});this.imageEditter.attr("contenteditable",false);this.imageEditter.on("click",a.proxy(function(){this.imageEdit(e)},this));f.append(this.imageEditter);var g=a('<span id="redactor-image-resizer" data-redactor="verified"></span>');g.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"});g.attr("contenteditable",false);f.append(g);f.append(e);return g},imageThumbClick:function(f){var g='<img id="image-marker" src="'+a(f.target).attr("rel")+'" alt="'+a(f.target).attr("title")+'" />';var h=this.getParent();if(this.opts.paragraphy&&a(h).closest("li").size()==0){g="<p>"+g+"</p>"}this.imageInsert(g,true)},imageCallbackLink:function(){var f=a("#redactor_file_link").val();if(f!==""){var e='<img id="image-marker" src="'+f+'" />';if(this.opts.linebreaks===false){e="<p>"+e+"</p>"}this.imageInsert(e,true)}else{this.modalClose()}},imageCallback:function(e){this.imageInsert(e)},imageInsert:function(g,h){this.selectionRestore();if(g!==false){var e="";if(h!==true){e='<img id="image-marker" src="'+g.filelink+'" />';var j=this.getParent();if(this.opts.paragraphy&&a(j).closest("li").size()==0){e="<p>"+e+"</p>"}}else{e=g}this.execCommand("inserthtml",e,false);var f=a(this.$editor.find("img#image-marker"));if(f.length){f.removeAttr("id")}else{f=false}this.sync();h!==true&&this.callback("imageUpload",f,g)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){a.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress-inline" style="display: none;"><span></span></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="'+this.opts.fileUploadParam+'" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label><label>"+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="center">'+this.opts.curLang.center+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><div style="width: 33%;"><button class="redactor_modal_delete_btn" id="redactor_image_delete_btn">'+this.opts.curLang._delete+'</button></div><div style="width: 33%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button></div><div style="width: 34%; float: right;"><button class="redactor_modal_action_btn" id="redactorSaveBtn">'+this.opts.curLang.save+"</button></div></footer>",modal_image:String()+'<section><div id="redactor_tabs"><a href="#" id="redactor-tab-control-1" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#" id="redactor-tab-control-2">'+this.opts.curLang.choose+'</a><a href="#" id="redactor-tab-control-3">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress-inline" style="display: none;"><span></span></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="'+this.opts.imageUploadParam+'" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /><br><br></div></section><footer><div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button></div><div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_upload_btn">'+this.opts.curLang.insert+"</button></div></footer>",modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button></div><div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_link_btn">'+this.opts.curLang.insert+"</button></div></footer>",modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button></div><div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_table_btn">'+this.opts.curLang.insert+"</button></div></footer>",modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button></div><div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_video_btn">'+this.opts.curLang.insert+"</button></div></footer>"})},modalInit:function(m,j,n,h){var g=a("#redactor_modal_overlay");if(!g.length){this.$overlay=g=a('<div id="redactor_modal_overlay" style="display: none;"></div>');a("body").prepend(this.$overlay)}if(this.opts.modalOverlay){g.show().on("click",a.proxy(this.modalClose,this))}var f=a("#redactor_modal");if(!f.length){this.$modal=f=a('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>');a("body").append(this.$modal)}a("#redactor_modal_close").on("click",a.proxy(this.modalClose,this));this.hdlModalClose=a.proxy(function(o){if(o.keyCode===this.keyCode.ESC){this.modalClose();return false}},this);a(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=false;if(j.indexOf("#")==0){this.modalcontent=a(j);a("#redactor_modal_inner").empty().append(this.modalcontent.html());this.modalcontent.html("")}else{a("#redactor_modal_inner").empty().append(j)}f.find("#redactor_modal_header").html(m);if(typeof a.fn.draggable!=="undefined"){f.draggable({handle:"#redactor_modal_header"});f.find("#redactor_modal_header").css("cursor","move")}var e=a("#redactor_tabs");if(e.length){var l=this;e.find("a").each(function(o,p){o++;a(p).on("click",function(q){q.preventDefault();e.find("a").removeClass("redactor_tabs_act");a(this).addClass("redactor_tabs_act");a(".redactor_tab").hide();a("#redactor_tab"+o).show();a("#redactor_tab_selected").val(o);if(l.isMobile()===false){var r=f.outerHeight();f.css("margin-top","-"+(r+10)/2+"px")}})})}f.find(".redactor_btn_modal_close").on("click",a.proxy(this.modalClose,this));if(this.opts.autoresize===true){this.saveModalScroll=this.document.body.scrollTop}else{this.saveModalScroll=this.$editor.scrollTop()}if(this.isMobile()===false){f.css({position:"fixed",top:"-2000px",left:"50%",width:n+"px",marginLeft:"-"+(n+60)/2+"px"}).show();this.modalSaveBodyOveflow=a(document.body).css("overflow");a(document.body).css("overflow","hidden")}else{f.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show()}if(typeof h==="function"){h()}a(document).off("focusin.modal");if(this.isMobile()===false){setTimeout(function(){var o=f.outerHeight();f.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(o+10)/2+"px"})},10)}},modalClose:function(){a("#redactor_modal_close").off("click",this.modalClose);a("#redactor_modal").fadeOut("fast",a.proxy(function(){var e=a("#redactor_modal_inner");if(this.modalcontent!==false){this.modalcontent.html(e.html());this.modalcontent=false}e.html("");if(this.opts.modalOverlay){a("#redactor_modal_overlay").hide().off("click",this.modalClose)}a(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",this.hdlModalClose);this.selectionRestore();if(this.opts.autoresize&&this.saveModalScroll){a(this.document.body).scrollTop(this.saveModalScroll)}else{if(this.opts.autoresize===false&&this.saveModalScroll){this.$editor.scrollTop(this.saveModalScroll)}}},this));if(this.isMobile()===false){a(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible")}return false},modalSetTab:function(e){a(".redactor_tab").hide();a("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(e-1).addClass("redactor_tabs_act");a("#redactor_tab"+e).show()},s3handleFileSelect:function(g){var j=g.target.files;for(var l=0,h;h=j[l];l++){this.s3uploadFile(h)}},s3uploadFile:function(e){this.s3executeOnSignedUrl(e,a.proxy(function(f){this.s3uploadToS3(e,f)},this))},s3executeOnSignedUrl:function(f,e){var h=new XMLHttpRequest();var g="?";if(this.opts.s3.search(/\?/)!="-1"){g="&"}h.open("GET",this.opts.s3+g+"name="+f.name+"&type="+f.type,true);if(h.overrideMimeType){h.overrideMimeType("text/plain; charset=x-user-defined")}h.onreadystatechange=function(j){if(this.readyState==4&&this.status==200){a("#redactor-progress").fadeIn();e(decodeURIComponent(this.responseText))}else{if(this.readyState==4&&this.status!=200){}}};h.send()},s3createCORSRequest:function(e,f){var g=new XMLHttpRequest();if("withCredentials" in g){g.open(e,f,true)}else{if(typeof XDomainRequest!="undefined"){g=new XDomainRequest();g.open(e,f)}else{g=null}}return g},s3uploadToS3:function(e,f){var g=this.s3createCORSRequest("PUT",f);if(!g){}else{g.onload=a.proxy(function(){if(g.status==200){a("#redactor-progress, #redactor-progress-drag").hide();var l=f.split("?");if(!l[0]){return false}this.selectionRestore();var h="";h='<img id="image-marker" src="'+l[0]+'" />';if(this.opts.paragraphy){h="<p>"+h+"</p>"}this.execCommand("inserthtml",h,false);var j=a(this.$editor.find("img#image-marker"));if(j.length){j.removeAttr("id")}else{j=false}this.sync();this.callback("imageUpload",j,false);this.modalClose();this.observeImages()}else{}},this);g.onerror=function(){};g.upload.onprogress=function(h){};g.setRequestHeader("Content-Type",e.type);g.setRequestHeader("x-amz-acl","public-read");g.send(e)}},uploadInit:function(f,g){this.uploadOptions={url:false,success:false,error:false,start:false,trigger:false,auto:false,input:false};a.extend(this.uploadOptions,g);var e=a("#"+f);if(e.length&&e[0].tagName==="INPUT"){this.uploadOptions.input=e;this.el=a(e[0].form)}else{this.el=e}this.element_action=this.el.attr("action");if(this.uploadOptions.auto){a(this.uploadOptions.input).change(a.proxy(function(h){this.el.submit(function(j){return false});this.uploadSubmit(h)},this))}else{if(this.uploadOptions.trigger){a("#"+this.uploadOptions.trigger).click(a.proxy(this.uploadSubmit,this))}}},uploadSubmit:function(f){a("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var e=this.document.createElement("div");var f='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';e.innerHTML=f;a(e).appendTo("body");if(this.uploadOptions.start){this.uploadOptions.start()}a("#"+this.id).load(a.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(e,j){if(this.uploadOptions.input){var h="redactorUploadForm"+this.id,g="redactorUploadFile"+this.id;this.form=a('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+j+'" name="'+h+'" id="'+h+'" enctype="multipart/form-data" />');if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){a.each(this.opts.uploadFields,a.proxy(function(n,o){if(o!=null&&o.toString().indexOf("#")===0){o=a(o).val()}var f=a("<input/>",{type:"hidden",name:n,value:o});a(this.form).append(f)},this))}var m=this.uploadOptions.input;var l=a(m).clone();a(m).attr("id",g).before(l).appendTo(this.form);a(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else{e.attr("target",j).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url);this.element.submit()}},uploadLoaded:function(){var f=a("#"+this.id)[0],e;if(f.contentDocument){e=f.contentDocument}else{if(f.contentWindow){e=f.contentWindow.document}else{e=window.frames[this.id].document}}if(this.uploadOptions.success){a("#redactor-progress").hide();if(typeof e!=="undefined"){var j=e.body.innerHTML;var h=j.match(/\{(.|\n)*\}/)[0];h=h.replace(/^\[/,"");h=h.replace(/\]$/,"");var g=a.parseJSON(h);if(typeof g.error=="undefined"){this.uploadOptions.success(g)}else{this.uploadOptions.error(this,g);this.modalClose()}}else{this.modalClose();alert("Upload failed!")}}this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(e,f){this.draguploadOptions=a.extend({url:false,success:false,error:false,preview:false,uploadFields:false,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:false},f);if(window.FormData===undefined){return false}this.droparea=a('<div class="redactor_droparea"></div>');this.dropareabox=a('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>");this.dropalternative=a('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);a(e).before(this.droparea);a(e).before(this.dropalternative);this.dropareabox.on("dragover",a.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",a.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=a.proxy(function(g){g.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");this.dragUploadAjax(this.draguploadOptions.url,g.dataTransfer.files[0],false,false,false,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(n,j,f,l,g,m){if(!f){var o=a.ajaxSettings.xhr();if(o.upload){o.upload.addEventListener("progress",a.proxy(this.uploadProgress,this),false)}a.ajaxSetup({xhr:function(){return o}})}var h=new FormData();if(m!==false){h.append(m,j)}else{h.append("file",j)}if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){a.each(this.opts.uploadFields,a.proxy(function(e,p){if(p!=null&&p.toString().indexOf("#")===0){p=a(p).val()}h.append(e,p)},this))}a.ajax({url:n,dataType:"html",data:h,cache:false,contentType:false,processData:false,type:"POST",success:a.proxy(function(p){p=p.replace(/^\[/,"");p=p.replace(/\]$/,"");var r=(typeof p==="string"?a.parseJSON(p):p);if(f){l.fadeOut("slow",function(){a(this).remove()});var e=a("<img>");e.attr("src",r.filelink).attr("id","drag-image-marker");this.insertNodeToCaretPositionFromPoint(g,e[0]);var q=a(this.$editor.find("img#drag-image-marker"));if(q.length){q.removeAttr("id")}else{q=false}this.sync();this.observeImages();if(q){this.callback("imageUpload",q,r)}if(typeof r.error!=="undefined"){this.callback("imageUploadError",r)}}else{if(typeof r.error=="undefined"){this.draguploadOptions.success(r)}else{this.draguploadOptions.error(this,r);this.draguploadOptions.success(false)}}},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return false},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return false},uploadProgress:function(f,h){var g=f.loaded?parseInt(f.loaded/f.total*100,10):f;this.dropareabox.text("Loading "+g+"% "+(h||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isIPad:function(){return/iPad/.test(navigator.userAgent)},normalize:function(e){if(typeof(e)==="undefined"){return 0}return parseInt(e.replace("px",""),10)},outerHtml:function(e){return a("<div>").append(a(e).eq(0).clone()).html()},isString:function(e){return Object.prototype.toString.call(e)=="[object String]"},isEmpty:function(e){e=e.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");e=e.replace(/\s/g,"");e=e.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"");return e==""},isIe11:function(){return !!navigator.userAgent.match(/Trident\/7\./)},browser:function(e){var g=navigator.userAgent.toLowerCase();var f=/(opr)[\/]([\w.]+)/.exec(g)||/(chrome)[ \/]([\w.]+)/.exec(g)||/(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(g)||/(webkit)[ \/]([\w.]+)/.exec(g)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(g)||/(msie) ([\w.]+)/.exec(g)||g.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(g)||g.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(g)||[];if(e=="version"){return f[2]}if(e=="webkit"){return(f[1]=="chrome"||f[1]=="webkit")}if(f[1]=="rv"){return e=="msie"}if(f[1]=="opr"){return e=="webkit"}return e==f[1]},oldIE:function(){if(this.browser("msie")&&parseInt(this.browser("version"),10)<9){return true}return false},getFragmentHtml:function(g){var e=g.cloneNode(true);var f=this.document.createElement("div");f.appendChild(e);return f.innerHTML},extractContent:function(){var g=this.$editor[0];var f=this.document.createDocumentFragment();var e;while((e=g.firstChild)){f.appendChild(e)}return f},isParentRedactor:function(e){if(!e){return false}if(this.opts.iframe){return e}if(a(e).parents("div.redactor_editor").length==0||a(e).hasClass("redactor_editor")){return false}else{return e}},currentOrParentIs:function(g){var f=this.getParent(),e=this.getCurrent();return f&&f.tagName===g?f:e&&e.tagName===g?e:false},isEndOfElement:function(){var e=this.getBlock();var g=this.getCaretOffset(e);var h=a.trim(a(e).text()).replace(/\n\r\n/g,"");var f=h.length;if(g==f){return true}else{return false}},isFocused:function(){var e,f=this.getSelection();if(f&&f.rangeCount&&f.rangeCount>0){e=f.getRangeAt(0).startContainer}if(!e){return false}if(this.opts.iframe){if(this.getCaretOffsetRange().equals()){return !this.$editor.is(e)}else{return true}}return a(e).closest("div.redactor_editor").length!=0},removeEmptyAttr:function(f,e){if(a(f).attr(e)==""){a(f).removeAttr(e)}},removeFromArrayByValue:function(e,g){var f=null;while((f=e.indexOf(g))!==-1){e.splice(f,1)}return e}};c.prototype.init.prototype=c.prototype;a.Redactor.fn.formatLinkify=function(s,g,f,h,q){var t=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,u=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,v=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,x=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig,w=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;var e=(this.$editor?this.$editor.get(0):this).childNodes,m=e.length;while(m--){var r=e[m];if(r.nodeType===3){var l=r.nodeValue;if(h&&l){var p='<iframe width="500" height="281" src="',o='" frameborder="0" allowfullscreen></iframe>';if(l.match(x)){l=l.replace(x,p+"//www.youtube.com/embed/$1"+o);a(r).after(l).remove()}else{if(l.match(w)){l=l.replace(w,p+"//player.vimeo.com/video/$2"+o);a(r).after(l).remove()}}}if(f&&l&&l.match(v)){l=l.replace(v,'<img src="$1">');a(r).after(l).remove()}if(g&&l&&(l.match(t)||l.match(u))){var j=(l.match(t)||l.match(u));j=j[0];if(j.length>q){j=j.substring(0,q)+"..."}l=l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(t,'$1<a href="'+s+'$2">'+a.trim(j)+"</a>$3").replace(u,'$1<a href="$2">'+a.trim(j)+"</a>$5");a(r).after(l).remove()}}else{if(r.nodeType===1&&!/^(a|button|textarea)$/i.test(r.tagName)){a.Redactor.fn.formatLinkify.call(r,s,g,f,h,q)}}}}})(jQuery);